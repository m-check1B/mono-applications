name: Backend Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-tests.yml'

jobs:
  test:
    name: Run Backend Tests with Coverage
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    strategy:
      matrix:
        python-version: ['3.11']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsndfile1 libsndfile1-dev portaudio19-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pytest-xdist  # For parallel test execution

      - name: Create test environment file
        run: |
          cat > .env.test << EOF
          # Test Environment Configuration
          ENVIRONMENT=test
          DEBUG=false
          SECRET_KEY=test-secret-key-for-ci-cd-pipeline
          DATABASE_URL=sqlite:///./test.db
          REDIS_URL=redis://localhost:6379/0

          # API Keys (mock values for testing)
          OPENAI_API_KEY=sk-test-key
          DEEPGRAM_API_KEY=test-key
          GOOGLE_API_KEY=test-key

          # Telephony (mock values)
          TWILIO_ACCOUNT_SID=test-sid
          TWILIO_AUTH_TOKEN=test-token
          TELNYX_API_KEY=test-key
          EOF

      - name: Run linting with ruff
        continue-on-error: true
        run: |
          if pip list | grep -q ruff; then
            ruff check . --select E,F,W --ignore E501
          else
            echo "Ruff not installed, skipping linting"
          fi

      - name: Run type checking with mypy
        continue-on-error: true
        run: |
          if pip list | grep -q mypy; then
            mypy app --ignore-missing-imports --no-strict-optional
          else
            echo "Mypy not installed, skipping type checking"
          fi

      - name: Run tests with pytest
        env:
          ENV_FILE: .env.test
          PYTHONPATH: ${{ github.workspace }}/backend
        run: |
          pytest \
            --verbose \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=70 \
            --maxfail=5 \
            --tb=short \
            -n auto \
            tests/

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./backend/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage-report
          path: backend/htmlcov/
          retention-days: 30

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MINIMUM_GREEN: 80
          MINIMUM_ORANGE: 70

      - name: Check coverage threshold
        run: |
          coverage_percent=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); print(root.attrib['line-rate'])" 2>/dev/null || echo "0")
          coverage_int=$(python -c "print(int(float($coverage_percent) * 100))")
          echo "Coverage: ${coverage_int}%"
          if [ $coverage_int -lt 70 ]; then
            echo "::error::Coverage ${coverage_int}% is below minimum threshold of 70%"
            exit 1
          fi

      - name: Test Summary
        if: always()
        run: |
          echo "### Backend Test Results :test_tube:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Version:** ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage Threshold:** 70%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed coverage report in artifacts." >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: Run safety check
        continue-on-error: true
        run: |
          safety check --json || echo "Safety check found vulnerabilities"

      - name: Run bandit security scan
        continue-on-error: true
        run: |
          bandit -r app -f json -o bandit-report.json || true
          if [ -f bandit-report.json ]; then
            cat bandit-report.json
          fi
