import{c as gt,a as f,f as y}from"../chunks/pFl1CK35.js";import{a as Vt}from"../chunks/0VtO9hYy.js";import{h as M,p as qt,s as x,a as Q,f as m,i as X,g as s,e as p,d as n,t as N,c as Kt,n as _,r as o,j as vt}from"../chunks/aQ_ifger.js";import{s as h}from"../chunks/DBuqHHqM.js";import{i as I}from"../chunks/BTxJJ6eU.js";import{r as Qt}from"../chunks/BqAhscvM.js";import{s as Xt}from"../chunks/DGR2HyJN.js";import{d as Yt}from"../chunks/C918u5xm.js";import{a as Zt}from"../chunks/CDxeFDgn.js";import{u as te}from"../chunks/CUF9Mhog.js";import{w as Y,g as bt}from"../chunks/B4dMqloI.js";import{R as ee,c as ae}from"../chunks/Zr3TcUzR.js";import{b as se,d as re}from"../chunks/J6IVVljB.js";import{R as mt,A as ne}from"../chunks/CaBw7UIl.js";import"../chunks/CnJ-dsFT.js";import{s as xt}from"../chunks/DaxPoLM8.js";import{l as _t,s as ht}from"../chunks/DzqNI6-e.js";import{I as yt}from"../chunks/D7pKbUF5.js";import{P as oe}from"../chunks/DuMvWK9u.js";import{P as ft}from"../chunks/C8ipYI_7.js";import{P as ie}from"../chunks/C6dIHe7_.js";function ce(v,d){const i=_t(d,["children","$$slots","$$events","$$legacy"]);const a=[["path",{d:"M4.9 19.1C1 15.2 1 8.8 4.9 4.9"}],["path",{d:"M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5"}],["circle",{cx:"12",cy:"12",r:"2"}],["path",{d:"M16.2 7.8c2.3 2.3 2.3 6.1 0 8.5"}],["path",{d:"M19.1 4.9C23 8.8 23 15.1 19.1 19"}]];yt(v,ht({name:"radio"},()=>i,{get iconNode(){return a},children:(l,g)=>{var e=gt(),r=M(e);xt(r,d,"default",{}),f(l,e)},$$slots:{default:!0}}))}function le(v,d){const i=_t(d,["children","$$slots","$$events","$$legacy"]);const a=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"}],["path",{d:"m9 12 2 2 4-4"}]];yt(v,ht({name:"shield-check"},()=>i,{get iconNode(){return a},children:(l,g)=>{var e=gt(),r=M(e);xt(r,d,"default",{}),f(l,e)},$$slots:{default:!0}}))}function de(v){let d="";const i=v.byteLength;for(let a=0;a<i;a+=1)d+=String.fromCharCode(v[a]);return btoa(d)}function ue(v){return de(new Uint8Array(v.buffer))}function pe(v="/test-outbound"){const d={status:"idle"},i=Y(d);let a=null;function l(){return se.getSnapshot().tokens?.accessToken}function g(){return a||(a=new ee({path:v,token:()=>l(),reconnect:!1}),a.onOpen(()=>{i.set({status:"connected",error:void 0})}),a.onMessage(e=>{let r=e.data;try{typeof e.data=="string"&&(r=JSON.parse(e.data))}catch(S){console.warn("Failed to parse realtime payload",S)}i.update(S=>({...S,lastEvent:r,lastEventAt:Date.now()}))}),a.onError(e=>{const r=e instanceof ErrorEvent?e.message:"WebSocket error";i.set({status:"error",error:r})}),a.onClose(e=>{i.set({status:"disconnected",error:e.wasClean?void 0:`Connection closed (${e.code})`})}),a)}return{subscribe:i.subscribe,connect(){i.set({status:"connecting"}),g().connect()},disconnect(){a?.disconnect(),a=null,i.set({status:"disconnected"})},send(e){a?.send(e)},reset(){a?.disconnect(),a=null,i.set(d)},getState(){return bt(i)}}}function ve(v="/test-inbound"){const d=pe(v),i=ae(),a=Y({status:"idle",session:d.getState(),audioStatus:i.getState().status});let l=null;d.subscribe(e=>{a.update(r=>({...r,session:e,status:e.status==="error"?"error":e.status==="connected"?"connected":e.status==="connecting"?"connecting":r.status}))}),i.subscribe(e=>{a.update(r=>({...r,audioStatus:e.status}))}),i.sendCapturedFrame(e=>{const r=ue(e);try{d.send(JSON.stringify({type:"audio-data",audioData:r}))}catch(S){console.error("Failed to send inbound audio frame",S)}});function g(e){switch(e.type){case"call-offer":a.update(r=>({...r,activeCall:{from:typeof e.from=="string"?e.from:void 0,metadata:e},lastEvent:e}));break;case"call-ended":a.update(r=>({...r,activeCall:void 0,lastEvent:e}));break;case"audio":typeof e.audio=="string"&&i.playBase64Audio(e.audio,typeof e.mimeType=="string"?e.mimeType:void 0).catch(r=>{console.error("Failed to play inbound audio chunk",r)});break;default:a.update(r=>({...r,lastEvent:e}))}}return d.subscribe(e=>{if(!e.lastEventAt||e.lastEventAt===l)return;l=e.lastEventAt;const r=e.lastEvent;r&&typeof r=="object"&&"type"in r&&g(r)}),{subscribe:a.subscribe,connect(){a.update(e=>({...e,status:"connecting",error:void 0})),d.connect()},disconnect(){d.disconnect(),i.stop(),a.update(e=>({...e,status:"idle",activeCall:void 0}))},async accept(){const e=await i.startMicrophone();if(!e.success){a.update(r=>({...r,error:e.error??"Microphone access failed."}));return}d.send(JSON.stringify({type:"accept-call"}))},decline(){d.send(JSON.stringify({type:"decline-call"})),a.update(e=>({...e,activeCall:void 0}))},getState(){return bt(a)}}}function me(v=15e3){const d=Y(null);let i=null;async function a(){try{const e=await re("/api/provider-health");d.set(e)}catch(e){console.error("Failed to fetch provider health",e)}}function l(){a(),i&&clearInterval(i),i=setInterval(a,v)}function g(){i&&clearInterval(i),i=null}return{subscribe:d.subscribe,start:l,stop:g,refresh:a}}var fe=y("<!> Listening...",1),ge=y("<!> Start Listening",1),be=y('<button class="btn btn-ghost"><!> Disconnect</button>'),xe=y('<div class="rounded-xl border border-primary-soft bg-primary-soft/20 px-4 py-3 text-sm text-text-secondary"><p class="font-semibold text-text-primary"> </p> <div class="mt-2 flex gap-2"><button class="btn btn-primary"><!> Accept</button> <button class="btn btn-ghost"><!> Decline</button></div></div>'),_e=y('<p class="rounded-lg border border-error/40 bg-error/10 px-3 py-2 text-sm text-error"> </p>'),he=y('<p> </p> <p> </p> <p class="text-xs text-text-muted"> </p>',1),ye=y('<p class="text-xs text-text-muted">Health data not available yet.</p>'),Se=y('<section class="space-y-6"><header class="space-y-1"><h1 class="text-2xl font-semibold text-text-primary">Incoming Call Control</h1> <p class="text-sm text-text-muted">Connect WebSocket listeners, monitor provider health, and auto-route callers using Stack 2026 ergonomics.</p></header> <div class="grid gap-4 lg:grid-cols-[2fr_3fr]"><article class="card"><div class="card-header"><h2 class="text-lg font-semibold text-text-primary">Provider Connection</h2> <button class="btn btn-ghost"><!> Reset</button></div> <div class="space-y-4"><div class="rounded-2xl border border-divider bg-secondary p-4 text-sm text-text-secondary"><p class="font-medium text-text-primary">WebSocket Endpoint</p> <p class="mt-1 text-xs text-text-muted"> </p> <p class="mt-1 text-xs text-text-muted"> </p></div> <div class="flex items-center justify-between rounded-2xl border border-divider bg-secondary/70 px-4 py-3"><div><p class="text-sm font-medium text-text-primary">Auto-Accept Calls</p> <p class="text-xs text-text-muted">Automatically answer inbound callers using the active campaign script.</p></div> <label class="relative inline-flex cursor-pointer items-center"><input type="checkbox" class="peer sr-only"/> <span class="peer h-6 w-11 rounded-full bg-divider transition peer-checked:bg-primary-soft"></span> <span class="absolute left-1 top-1 h-4 w-4 rounded-full bg-text-muted transition peer-checked:translate-x-5 peer-checked:bg-primary"></span></label></div> <div class="flex gap-2"><button><!></button> <!></div> <!> <!></div></article> <!> <article class="card"><div class="card-header"><div class="flex items-center gap-2 text-text-primary"><!> <h2 class="text-lg font-semibold">Realtime Events</h2></div></div> <div class="space-y-3 text-sm text-text-secondary"><p class="rounded-2xl border border-divider bg-secondary px-4 py-3"> </p> <p class="text-xs text-text-muted"> </p></div></article></div> <article class="card"><div class="card-header"><h2 class="text-lg font-semibold text-text-primary">Provider Health</h2> <button class="btn btn-ghost btn-sm"><!> Refresh</button></div> <div class="space-y-2 text-sm text-text-secondary"><!></div></article></section>');function We(v,d){qt(d,!0);const i=te(),a=ve("/test-inbound");let l=x(Q(a.getState()));const g=a.subscribe(t=>{m(l,t,!0)}),e=me();let r=x(null);const S=e.subscribe(t=>{m(r,t,!0)});let w=x(Q([])),Z=x(null),tt=x(null),C=x(Q([])),b=x(!1),z=x(!0);function St(){m(b,!s(b)),s(b)?a.connect():a.disconnect()}function Ct(){m(b,!1),m(z,!0),a.disconnect()}function kt(){a.accept()}function $t(){a.decline()}const wt=vt(()=>!!s(l).activeCall);let R=x(void 0);X(()=>{if(!s(b)||!s(z))return;const t=s(l).activeCall?.from;t&&(s(R)===t&&s(l).audioStatus==="recording"||(m(R,t,!0),a.accept()))}),X(()=>{s(l).activeCall||m(R,void 0)}),X(()=>{if(s(l).lastEvent&&typeof s(l).lastEvent=="object"){const t=s(l).lastEvent;if(t.type==="transcription"&&t.text&&t.role&&m(w,[...s(w),{role:t.role,content:t.text,timestamp:new Date}],!0),t.type==="text"&&t.text&&m(w,[...s(w),{role:"assistant",content:t.text,timestamp:new Date}],!0),t.type==="intent-analysis"&&m(Z,t.data,!0),t.type==="sentiment-analysis"&&m(tt,t.data,!0),t.type==="suggestion"){const c={id:t.data.id||Math.random().toString(36).substr(2,9),type:t.data.type||"response",title:t.data.title||"AI Suggestion",description:t.data.description||"",priority:t.data.priority||"medium",confidence:t.data.confidence||.5,status:"pending",timestamp:new Date};m(C,[...s(C),c],!0)}}});function At(t,c){if(m(C,s(C).map(u=>u.id===t?{...u,status:c==="accept"?"accepted":"rejected"}:u),!0),c==="accept"){const u=s(C).find(E=>E.id===t);u&&console.log("Accepted suggestion:",u)}}function Et(t){switch(t){case"connecting":return"Connectingâ€¦";case"connected":return"Connected";case"error":return"Error";default:return"Idle"}}e.start(),Vt(()=>{a.disconnect(),g(),e.stop(),S()});var F=Se(),L=p(n(F),2),T=n(L),O=n(T),j=p(n(O),2);j.__click=Ct;var Pt=n(j);mt(Pt,{class:"size-4"}),_(),o(j),o(O);var et=p(O,2),H=n(et),J=p(n(H),2),It=n(J);o(J);var at=p(J,2),Mt=n(at);o(at),o(H);var B=p(H,2),st=p(n(B),2),rt=n(st);Qt(rt),_(4),o(st),o(B);var W=p(B,2),A=n(W);A.__click=St;var zt=n(A);{var Dt=t=>{var c=fe(),u=M(c);le(u,{class:"size-4"}),_(),f(t,c)},Nt=t=>{var c=ge(),u=M(c);oe(u,{class:"size-4"}),_(),f(t,c)};I(zt,t=>{s(b)?t(Dt):t(Nt,!1)})}o(A);var Rt=p(A,2);{var Ft=t=>{var c=be();c.__click=()=>a.disconnect();var u=n(c);ft(u,{class:"size-4"}),_(),o(c),f(t,c)};I(Rt,t=>{s(b)&&t(Ft)})}o(W);var nt=p(W,2);{var Lt=t=>{var c=xe(),u=n(c),E=n(u);o(u);var k=p(u,2),$=n(k);$.__click=kt;var D=n($);ie(D,{class:"size-4"}),_(),o($);var P=p($,2);P.__click=$t;var K=n(P);ft(K,{class:"size-4"}),_(),o(P),o(k),o(c),N(()=>h(E,`Incoming call from ${s(l).activeCall?.from??"Unknown"??""}`)),f(t,c)};I(nt,t=>{s(wt)&&t(Lt)})}var Tt=p(nt,2);{var Ot=t=>{var c=_e(),u=n(c,!0);o(c),N(()=>h(u,s(l).error)),f(t,c)};I(Tt,t=>{s(l).error&&t(Ot)})}o(et),o(T);var ot=p(T,2);{let t=vt(()=>s(b)&&s(l).session.status==="connected");ne(ot,{get messages(){return s(w)},get isLive(){return s(t)},get intent(){return s(Z)},get sentiment(){return s(tt)},get suggestions(){return s(C)},onSuggestionAction:At})}var it=p(ot,2),G=n(it),ct=n(G),jt=n(ct);ce(jt,{class:"size-5"}),_(2),o(ct),o(G);var lt=p(G,2),U=n(lt),Ht=n(U,!0);o(U);var dt=p(U,2),Jt=n(dt);o(dt),o(lt),o(it),o(L);var ut=p(L,2),V=n(ut),q=p(n(V),2);q.__click=()=>e.refresh();var Bt=n(q);mt(Bt,{class:"size-4"}),_(),o(q),o(V);var pt=p(V,2),Wt=n(pt);{var Gt=t=>{var c=he(),u=M(c),E=n(u);o(u);var k=p(u,2),$=n(k);o(k);var D=p(k,2),P=n(D);o(D),N(K=>{h(E,`Status: ${s(r).providerHealth?.gemini?.status??"unknown"??""}`),h($,`Active connections: ${s(r).activeConnections??0??""}`),h(P,`Last updated: ${K??""}`)},[()=>new Date(s(r).timestamp??Date.now()).toLocaleTimeString()]),f(t,c)},Ut=t=>{var c=ye();f(t,c)};I(Wt,t=>{s(r)?t(Gt):t(Ut,!1)})}o(pt),o(ut),o(F),N((t,c)=>{h(It,`${i.wsUrl??""}/test-inbound`),h(Mt,`Session: ${t??""}`),Xt(A,1,`btn ${s(b)?"btn-secondary":"btn-primary"}`),h(Ht,c),h(Jt,`Audio status: ${s(l).audioStatus??""}. When connected, microphone audio streams to Gemini and responses play through the browser.`)},[()=>Et(s(l).session.status),()=>s(l).lastEvent?JSON.stringify(s(l).lastEvent):"No inbound events yet."]),Zt(rt,()=>s(z),t=>m(z,t)),f(v,F),Kt()}Yt(["click"]);export{We as component};
