import{w as M,g as b}from"./B4dMqloI.js";const o=globalThis.__sveltekit_zku6u.env,w=o.PUBLIC_BACKEND_URL&&o.PUBLIC_BACKEND_URL.trim().length>0?o.PUBLIC_BACKEND_URL:"https://gemini-api.verduona.com",Z=o.PUBLIC_WS_URL&&o.PUBLIC_WS_URL.trim().length>0?o.PUBLIC_WS_URL:w.replace(/^http/,"ws"),z=o.PUBLIC_TWILIO_FROM_NUMBER&&o.PUBLIC_TWILIO_FROM_NUMBER.trim().length>0?o.PUBLIC_TWILIO_FROM_NUMBER:"+420228810376",G={US:o.PUBLIC_TWILIO_FROM_NUMBER_US&&o.PUBLIC_TWILIO_FROM_NUMBER_US.trim().length>0?o.PUBLIC_TWILIO_FROM_NUMBER_US:"+18455954168",CZ:o.PUBLIC_TWILIO_FROM_NUMBER_CZ&&o.PUBLIC_TWILIO_FROM_NUMBER_CZ.trim().length>0?o.PUBLIC_TWILIO_FROM_NUMBER_CZ:"+420228810376",ES:o.PUBLIC_TWILIO_FROM_NUMBER_ES&&o.PUBLIC_TWILIO_FROM_NUMBER_ES.trim().length>0?o.PUBLIC_TWILIO_FROM_NUMBER_ES:"+34123456789"},I={auth:"operator-console.auth",theme:"operator-console.theme",targetCompanies:"operator-console.target-companies"},N=["application/json","application/ld+json"];function P(t){if(t.startsWith("http://")||t.startsWith("https://"))return t;const e=t.startsWith("/")?t:`/${t}`;return`${w}${e}`}function A(t){return t?t instanceof Headers?new Headers(t):new Headers(t):new Headers}function E(t,e=1e3){const s=Math.min(e*Math.pow(2,t),3e4),r=Math.random()*.3*s;return s+r}function F(t){return t===429||t>=500&&t<600}async function x(){try{return await O.refreshTokens()}catch(t){return console.error("Failed to refresh tokens",t),!1}}async function U(t,e={}){const{retryOnAuthError:s=!0,autoJson:r=!0,maxRetries:n=3,retryDelay:i=1e3,headers:c,...y}=e,_=P(t),p=A(c),{tokens:R}=O.getSnapshot();y.body&&!p.has("Content-Type")&&p.set("Content-Type","application/json"),R?.accessToken&&p.set("Authorization",`Bearer ${R.accessToken}`);let T=null;for(let l=0;l<=n;l++)try{const a=await fetch(_,{...y,headers:p});if(a.status===401&&s&&await x())return U(t,{...e,retryOnAuthError:!1});if(!a.ok){let h;if(r)try{h=await a.clone().json()}catch{h=await a.text()}const B=Object.assign(new Error(a.statusText),{status:a.status,payload:h});if(F(a.status)&&l<n){T=B;const L=E(l,i);console.warn(`Request failed with status ${a.status}, retrying in ${L}ms...`),await new Promise(C=>setTimeout(C,L));continue}throw B}if(!r)return a;const g=a.headers.get("Content-Type")??"";return N.some(h=>g.includes(h))?a.json():a.text()}catch(a){if(l<n){T=a;const g=E(l,i);console.warn(`Network error, retrying in ${g}ms...`,a),await new Promise(S=>setTimeout(S,g));continue}throw a}throw T||new Error("Request failed after all retries")}async function Y(t,e){return U(t,{...e,method:"GET"})}async function m(t,e,s={}){const{body:r,...n}=s;return U(t,{...n,method:"POST",body:r??JSON.stringify(e)})}function W(t){return m("/api/v1/auth/login",t)}function v(t){return m("/api/v1/auth/register",t)}function D(){return m("/api/v1/auth/logout",{})}class ${channel=null;listeners=new Map;tabId;isSupported;constructor(){this.tabId=this.generateTabId(),this.isSupported=typeof BroadcastChannel<"u",this.isSupported&&(this.channel=new BroadcastChannel("voice-kraliki-sync"),this.setupMessageHandler())}generateTabId(){return`tab-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}setupMessageHandler(){this.channel&&(this.channel.onmessage=e=>{const s=e.data;if(s.tabId===this.tabId)return;const r=this.listeners.get(s.type);r&&r.forEach(n=>n(s))})}broadcast(e,s){if(!this.channel){console.warn("BroadcastChannel not supported");return}const r={type:e,payload:s,timestamp:Date.now(),tabId:this.tabId};this.channel.postMessage(r)}subscribe(e,s){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(s),()=>{this.listeners.get(e)?.delete(s)}}close(){this.channel&&(this.channel.close(),this.channel=null),this.listeners.clear()}isAvailable(){return this.isSupported&&this.channel!==null}}const u=new $;typeof window<"u"&&window.addEventListener("beforeunload",()=>{u.close()});const d={status:"unauthenticated",user:null,tokens:null,error:null};function f(t){try{localStorage.setItem(I.auth,JSON.stringify({tokens:t.tokens,user:t.user}))}catch(e){console.error("Failed to persist auth state",e)}}function j(){try{const t=localStorage.getItem(I.auth);if(!t)return{tokens:null,user:null};const e=JSON.parse(t);return{tokens:e.tokens??null,user:e.user??null}}catch(t){return console.warn("Failed to restore auth state",t),{tokens:null,user:null}}}async function J(t){try{const e=await fetch(`${w}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:t})});if(!e.ok)throw new Error(`Failed to refresh token: ${e.statusText}`);return await e.json()}catch(e){throw console.error("Token refresh failed",e),e}}function k(t,e){u.isAvailable()&&u.broadcast("auth_updated",{tokens:t,user:e})}function H(){u.isAvailable()&&u.broadcast("auth_logout",{})}function K(){const t=j(),e=M({...d,...t,status:t.tokens?"authenticated":"unauthenticated"});return u.isAvailable()&&(u.subscribe("auth_updated",s=>{const{tokens:r,user:n}=s.payload;e.update(()=>{const i={status:"authenticated",tokens:r,user:n,error:null};return f(i),i})}),u.subscribe("auth_logout",()=>{e.set(d),localStorage.removeItem(I.auth)})),{subscribe:e.subscribe,getSnapshot:()=>b(e),setAuthenticating(){e.update(s=>({...s,status:"authenticating",error:null}))},setAuthenticated(s){e.update(()=>{const r={status:"authenticated",tokens:s.tokens,user:s.user,error:null};return f(r),r})},setError(s){e.update(r=>({...r,error:s,status:"unauthenticated"}))},clear(){e.set(d),localStorage.removeItem(I.auth)},async login(s){this.setAuthenticating();try{const r=await W(s),n={accessToken:r.access_token,refreshToken:r.refresh_token,expiresAt:r.expires_at},i=r.user??null;return e.update(()=>{const c={status:"authenticated",tokens:n,user:i,error:null};return f(c),c}),k(n,i),{success:!0}}catch(r){const n=r instanceof Error?r.message:"Failed to sign in";return e.set({...d,error:n}),{success:!1,error:n}}},async register(s){this.setAuthenticating();try{const r=await v(s),n={accessToken:r.access_token,refreshToken:r.refresh_token,expiresAt:r.expires_at},i=r.user??null;return e.update(()=>{const c={status:"authenticated",tokens:n,user:i,error:null};return f(c),c}),k(n,i),{success:!0}}catch(r){const n=r instanceof Error?r.message:"Failed to register";return e.set({...d,error:n}),{success:!1,error:n}}},async logout(){try{await D()}catch(s){console.warn("Logout request failed",s)}finally{this.clear(),H()}},async refreshTokens(){const s=b(e),r=s.tokens?.refreshToken;if(!r)return!1;e.update(n=>({...n,status:"refreshing"}));try{const n=await J(r),i={accessToken:n.access_token,refreshToken:n.refresh_token??r,expiresAt:n.expires_at},c=n.user??s.user;return e.update(y=>{const _={status:"authenticated",tokens:i,user:c,error:null};return f(_),_}),k(i,c),!0}catch{return e.set({...d,error:"Session expired"}),!1}}}}const O=K();export{w as B,G as C,z as D,I as S,Z as W,m as a,O as b,u as c,Y as d};
