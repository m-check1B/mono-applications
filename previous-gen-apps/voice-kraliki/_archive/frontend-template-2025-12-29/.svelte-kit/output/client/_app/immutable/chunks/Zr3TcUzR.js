import{c as U,a as q}from"./pFl1CK35.js";import"./CnJ-dsFT.js";import{h as D}from"./aQ_ifger.js";import{s as _}from"./DaxPoLM8.js";import{l as L,s as I}from"./DzqNI6-e.js";import{I as O}from"./D7pKbUF5.js";import{w as F,g as v}from"./B4dMqloI.js";import{W as B}from"./J6IVVljB.js";function Y(p,e){const s=L(e,["children","$$slots","$$events","$$legacy"]);const r=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"}],["path",{d:"M12 9v4"}],["path",{d:"M12 17h.01"}]];O(p,I({name:"triangle-alert"},()=>s,{get iconNode(){return r},children:(h,u)=>{var a=U(),f=D(a);_(f,e,"default",{}),q(h,a)},$$slots:{default:!0}}))}function Z(){const p=F({status:"idle"});let e=null,s=null,r=null,h=null,u=null,a=null,f=null;const m=new Set;let g=0;function c(t){p.update(o=>({...o,...t}))}function R(t){const o=atob(t),i=o.length,n=new Uint8Array(i);for(let l=0;l<i;l+=1)n[l]=o.charCodeAt(l);return n}function H(t){if(!t)return 24e3;const o=t.match(/rate=(\d+)/i);if(o){const i=Number(o[1]);if(!Number.isNaN(i)&&i>0)return i}return 24e3}function $(t,o=1){if(!t)return o;const i=t.match(/channels=(\d+)/i);if(i){const n=Number(i[1]);if(!Number.isNaN(n)&&n>0)return n}return o}function A(){const t=window.AudioContext||window.webkitAudioContext;if(!t)throw new Error("Web Audio API is not supported in this browser");return(!e||e.state==="closed")&&(e=new t),(!s||s.state==="closed")&&(s=new t),{input:e,output:s}}async function M(){e&&e.state==="suspended"&&await e.resume(),s&&s.state==="suspended"&&await s.resume()}function C(t){return u||(u=t.createGain(),u.gain.value=1,u.connect(t.destination)),u}async function E(t){if(a)return a;try{return await t.audioWorklet.addModule("/worklets/audio-processor.js"),a=new AudioWorkletNode(t,"audio-processor"),a.port.onmessage=o=>{if(o.data?.type==="audioData"&&f){const i=o.data.buffer;f(i)}},a}catch(o){throw c({status:"error",error:"AudioWorklet not available."}),o}}function x(t,o,i,n){const l=Math.floor(t.length/2/n),k=o.createBuffer(n,l,i),S=new Int16Array(t.buffer,t.byteOffset,l*n);for(let w=0;w<n;w+=1){const y=k.getChannelData(w);for(let d=0;d<l;d+=1){const b=d*n+w;y[d]=S[b]/32768}}return k}async function W(){if(!navigator.mediaDevices?.getUserMedia)return c({status:"error",error:"Microphone access is not supported in this environment."}),{success:!1,error:"Microphone access is not supported."};try{c({status:"requesting-mic",error:void 0,message:"Requesting microphone accessâ€¦"});const t=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,echoCancellation:!0,noiseSuppression:!1,autoGainControl:!1}});r=t;const{input:o,output:i}=A();return await M(),h=o.createMediaStreamSource(t),C(i),await E(o),a?.port.postMessage({type:"config",sampleRate:o.sampleRate}),h.connect(a),g=i.currentTime,c({status:"recording",message:"Microphone capture active."}),{success:!0}}catch(t){console.error("Failed to start microphone",t);const o=t instanceof Error?t.message:"Unknown microphone error";return c({status:"error",error:o}),{success:!1,error:o}}}function N(){if(r&&(r.getTracks().forEach(t=>t.stop()),r=null),h&&(h.disconnect(),h=null),a){try{a.port.postMessage({type:"stop"})}catch(t){console.warn("Failed to notify worklet stop",t)}a.disconnect(),a=null}m.forEach(t=>{try{t.stop()}catch(o){console.warn("Error stopping audio source",o)}}),m.clear(),g=s?s.currentTime:0,c({status:"ready",message:"Microphone stopped."})}async function T(){N(),u&&(u.disconnect(),u=null),e&&e.state!=="closed"&&await e.close(),s&&s.state!=="closed"&&await s.close(),e=null,s=null,g=0,c({status:"idle",message:void 0,error:void 0})}async function P(t,o,i=1){if(t)try{const{output:n}=A();await M();const l=C(n),k=R(t),S=H(o),w=$(o,i),y=x(k,n,S,w),d=n.createBufferSource();d.buffer=y,d.connect(l);const b=Math.max(g,n.currentTime);d.start(b),g=b+y.duration,d.addEventListener("ended",()=>{m.delete(d)}),m.add(d),c({status:v(p).status==="error"?"ready":v(p).status,message:`Playing audio chunk (${y.duration.toFixed(2)}s)`,lastPlaybackAt:Date.now(),error:void 0})}catch(n){console.error("Failed to play audio chunk",n);const l=n instanceof Error?n.message:"Unable to play audio chunk";c({status:"error",error:l})}}return{subscribe:p.subscribe,startMicrophone:W,stop:N,playBase64Audio:P,cleanup:T,setMessage(t){c({message:t})},sendCapturedFrame(t){f=t},getState(){return v(p)}}}class ee{socket=null;reconnectAttempts=0;options;messageHandlers=new Set;openHandlers=new Set;closeHandlers=new Set;errorHandlers=new Set;shouldReconnect;constructor(e={}){this.options={path:e.path??"",query:e.query??{},protocols:e.protocols??[],reconnect:e.reconnect??!0,reconnectDelayMs:e.reconnectDelayMs??2e3,maxReconnectAttempts:e.maxReconnectAttempts??10,token:e.token},this.shouldReconnect=this.options.reconnect}connect(){if(this.socket&&(this.socket.readyState===WebSocket.OPEN||this.socket.readyState===WebSocket.CONNECTING))return;const e=this.buildUrl();this.shouldReconnect=this.options.reconnect,this.socket=new WebSocket(e,this.options.protocols),this.socket.addEventListener("open",s=>{this.reconnectAttempts=0;for(const r of this.openHandlers)r(s)}),this.socket.addEventListener("message",s=>{for(const r of this.messageHandlers)r(s)}),this.socket.addEventListener("close",s=>{for(const r of this.closeHandlers)r(s);this.options.reconnect&&this.scheduleReconnect()}),this.socket.addEventListener("error",s=>{for(const r of this.errorHandlers)r(s)})}disconnect(){this.shouldReconnect=!1,this.socket&&(this.socket.close(),this.socket=null)}setToken(e){this.options={...this.options,token:e}}setQuery(e){this.options={...this.options,query:{...e}}}updateQuery(e){this.options={...this.options,query:{...this.options.query,...e}}}setPath(e){this.options={...this.options,path:e}}send(e){this.socket?.readyState===WebSocket.OPEN?this.socket.send(e):console.warn("WebSocket not connected. Message not sent.")}onMessage(e){return this.messageHandlers.add(e),()=>this.messageHandlers.delete(e)}onOpen(e){return this.openHandlers.add(e),()=>this.openHandlers.delete(e)}onClose(e){return this.closeHandlers.add(e),()=>this.closeHandlers.delete(e)}onError(e){return this.errorHandlers.add(e),()=>this.errorHandlers.delete(e)}scheduleReconnect(){!this.shouldReconnect||!this.options.reconnect||this.reconnectAttempts>=this.options.maxReconnectAttempts||(this.reconnectAttempts+=1,setTimeout(()=>this.connect(),this.options.reconnectDelayMs))}buildUrl(){const{path:e,query:s,token:r}=this.options,h=e?.startsWith("/")?e:`/${e??""}`,u=`${B}${h}`,a=new URLSearchParams;if(s)for(const[g,c]of Object.entries(s))c!=null&&a.set(g,String(c));const f=typeof r=="function"?r():r;f&&a.set("token",f);const m=a.toString();return m.length>0?`${u}?${m}`:u}}export{ee as R,Y as T,Z as c};
