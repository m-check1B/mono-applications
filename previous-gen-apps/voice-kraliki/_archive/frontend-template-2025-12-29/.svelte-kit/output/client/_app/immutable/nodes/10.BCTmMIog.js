import{c as Oe,a as b,f as C}from"../chunks/pFl1CK35.js";import"../chunks/CnJ-dsFT.js";import{o as xe,a as Be}from"../chunks/0VtO9hYy.js";import{h as ge,p as he,c as _e,d as a,e as v,t as j,g as t,s as oe,n as je,r as s,j as de,f as q,a as ze,k as Ze,i as et}from"../chunks/aQ_ifger.js";import{i as tt}from"../chunks/ft9JqUN4.js";import{l as qe,s as De,p as Ce}from"../chunks/DzqNI6-e.js";import{s as k}from"../chunks/DBuqHHqM.js";import{i as E}from"../chunks/BTxJJ6eU.js";import{e as st,d as Me}from"../chunks/C918u5xm.js";import{a as $e,s as Je}from"../chunks/BPSUqZ7R.js";import{d as Ee,w as nt}from"../chunks/B4dMqloI.js";import{c as ve,d as at,a as rt}from"../chunks/J6IVVljB.js";import{e as Se,i as Ne}from"../chunks/oqRKM5NY.js";import{c as ot}from"../chunks/CEkw2kT7.js";import{s as ce}from"../chunks/DGR2HyJN.js";import{b as Ae}from"../chunks/Bo6fAwy7.js";import{B as Pe}from"../chunks/Civmg7zw.js";import{U as Le}from"../chunks/BS24MMqf.js";import{s as Fe}from"../chunks/DaxPoLM8.js";import{I as Qe}from"../chunks/D7pKbUF5.js";import{a as Ue,r as it}from"../chunks/BqAhscvM.js";import{b as Ke}from"../chunks/CDxeFDgn.js";import{M as ct}from"../chunks/BcyIxIqt.js";import{X as dt}from"../chunks/CMhIKE5Z.js";import{g as lt}from"../chunks/CTjsJUPt.js";import{P as ut}from"../chunks/DxRKn0x_.js";import{S as vt}from"../chunks/BztEPeEE.js";import{U as Ie,C as mt}from"../chunks/BsEdNM_k.js";import{P as pt}from"../chunks/W1CsE6Bq.js";import{S as Xe}from"../chunks/DYJXI9Zw.js";import{t as ft,f as xt}from"../chunks/DTDLo_aH.js";import{R as gt}from"../chunks/DVBVNVSq.js";import{W as ht,a as _t}from"../chunks/C0dSNkxj.js";import{M as yt}from"../chunks/t44G3NBe.js";function bt(f,c){const n=qe(c,["children","$$slots","$$events","$$legacy"]);const i=[["circle",{cx:"12",cy:"12",r:"10"}],["path",{d:"M12 16v-4"}],["path",{d:"M12 8h.01"}]];Qe(f,De({name:"info"},()=>n,{get iconNode(){return i},children:(e,o)=>{var d=Oe(),l=ge(d);Fe(l,c,"default",{}),b(e,d)},$$slots:{default:!0}}))}function wt(f,c){const n=qe(c,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M13.234 20.252 21 12.3"}],["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 0 2.828 2 2 0 0 0 2.828 0l8.414-8.586a4 4 0 0 0 0-5.656 4 4 0 0 0-5.656 0l-8.415 8.585a6 6 0 1 0 8.486 8.486"}]];Qe(f,De({name:"paperclip"},()=>n,{get iconNode(){return i},children:(e,o)=>{var d=Oe(),l=ge(d);Fe(l,c,"default",{}),b(e,d)},$$slots:{default:!0}}))}function St(f,c){const n=qe(c,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z"}],["path",{d:"m21.854 2.147-10.94 10.939"}]];Qe(f,De({name:"send"},()=>n,{get iconNode(){return i},children:(e,o)=>{var d=Oe(),l=ge(d);Fe(l,c,"default",{}),b(e,d)},$$slots:{default:!0}}))}const Ct=async({parent:f})=>{const c=await f(),n=`chat_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return{...c,sessionId:n,userId:"user_123",companyId:"company_456"}},Ks=Object.freeze(Object.defineProperty({__proto__:null,load:Ct},Symbol.toStringTag,{value:"Module"}));class $t{queue=[];isOnline=navigator.onLine;reconnectAttempts=0;maxReconnectAttempts=10;reconnectDelay=1e3;maxReconnectDelay=3e4;reconnectTimer=null;heartbeatTimer=null;storageKey="chat_offline_queue";onConnectionChange;onMessageQueued;onMessageSent;onMessageFailed;constructor(){this.loadQueueFromStorage(),this.setupEventListeners(),this.startHeartbeat()}setupEventListeners(){window.addEventListener("online",()=>this.handleConnectionChange(!0)),window.addEventListener("offline",()=>this.handleConnectionChange(!1))}handleConnectionChange(c){const n=!this.isOnline;this.isOnline=c,c&&n?(this.reconnectAttempts=0,this.reconnectDelay=1e3,this.processQueue()):c||this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.notifyConnectionChange()}startHeartbeat(){const c=async()=>{if(this.isOnline)try{if(!(await fetch("/api/health",{method:"HEAD",cache:"no-cache",signal:AbortSignal.timeout(5e3)})).ok)throw new Error("Health check failed");this.reconnectAttempts=0,this.reconnectDelay=1e3}catch(n){console.warn("Connection heartbeat failed:",n),this.isOnline&&this.handleConnectionIssue()}this.heartbeatTimer=requestAnimationFrame(()=>{setTimeout(c,3e4)})};c()}handleConnectionIssue(){this.reconnectAttempts++,this.reconnectAttempts>=3&&this.handleConnectionChange(!1)}queueMessage(c,n,i=3){const e={id:`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:c,timestamp:Date.now(),data:n,retryCount:0,maxRetries:i,nextRetryTime:Date.now()};return this.queue.push(e),this.saveQueueToStorage(),this.onMessageQueued?.(e),this.notifyConnectionChange(),this.isOnline&&this.processQueue(),e.id}async processQueue(){if(!this.isOnline||this.queue.length===0)return;const c=Date.now(),n=this.queue.filter(i=>i.nextRetryTime<=c);if(n.length!==0){for(const i of n)try{await this.sendMessage(i),this.removeMessage(i.id),this.onMessageSent?.(i.id)}catch(e){console.error(`Failed to send message ${i.id}:`,e),this.handleMessageFailure(i,e)}this.queue.length>0&&setTimeout(()=>this.processQueue(),1e3)}}async sendMessage(c){const{type:n,data:i}=c;switch(n){case"message":await this.sendChatMessage(i);break;case"session_update":await this.sendSessionUpdate(i);break;case"context_update":await this.sendContextUpdate(i);break;default:throw new Error(`Unknown message type: ${n}`)}}async sendChatMessage(c){const n=await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`)}async sendSessionUpdate(c){const{session_id:n,context:i}=c,e=await fetch(`/api/chat/sessions/${n}/context`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({context:i})});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`)}async sendContextUpdate(c){const{session_id:n,customer_info:i}=c,e=await fetch(`/api/chat/sessions/${n}/context/customer-info`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`)}handleMessageFailure(c,n){if(c.retryCount++,c.retryCount>=c.maxRetries){this.removeMessage(c.id),this.onMessageFailed?.(c.id,n);return}const i=Math.min(1e3*Math.pow(2,c.retryCount),3e4);c.nextRetryTime=Date.now()+i,this.queue.sort((e,o)=>e.nextRetryTime-o.nextRetryTime),this.saveQueueToStorage(),setTimeout(()=>this.processQueue(),i)}removeMessage(c){const n=this.queue.findIndex(i=>i.id===c);n!==-1&&(this.queue.splice(n,1),this.saveQueueToStorage(),this.notifyConnectionChange())}saveQueueToStorage(){try{localStorage.setItem(this.storageKey,JSON.stringify(this.queue))}catch(c){console.error("Failed to save queue to storage:",c)}}loadQueueFromStorage(){try{const c=localStorage.getItem(this.storageKey);if(c){this.queue=JSON.parse(c);const n=Date.now()-1440*60*1e3;this.queue=this.queue.filter(i=>i.timestamp>n),this.saveQueueToStorage()}}catch(c){console.error("Failed to load queue from storage:",c),this.queue=[]}}notifyConnectionChange(){this.onConnectionChange?.({isOnline:this.isOnline,lastConnected:this.isOnline?Date.now():null,reconnectAttempts:this.reconnectAttempts,queuedMessages:this.queue.length})}getConnectionStatus(){return{isOnline:this.isOnline,lastConnected:this.isOnline?Date.now():null,reconnectAttempts:this.reconnectAttempts,queuedMessages:this.queue.length}}getQueuedMessages(){return[...this.queue]}clearQueue(){this.queue=[],this.saveQueueToStorage(),this.notifyConnectionChange()}on(c,n){switch(c){case"connectionChange":this.onConnectionChange=n;break;case"messageQueued":this.onMessageQueued=n;break;case"messageSent":this.onMessageSent=n;break;case"messageFailed":this.onMessageFailed=n;break}}destroy(){this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.heartbeatTimer&&cancelAnimationFrame(this.heartbeatTimer),window.removeEventListener("online",()=>this.handleConnectionChange(!0)),window.removeEventListener("offline",()=>this.handleConnectionChange(!1))}}const ne=new $t;function We(f,c){ve.isAvailable()&&ve.broadcast("session_updated",{sessionId:f,data:c,timestamp:Date.now()})}function Mt(f){ve.isAvailable()&&ve.broadcast("session_ended",{sessionId:f,timestamp:Date.now()})}function Tt(f){return ve.isAvailable()?ve.subscribe("session_updated",c=>{const{sessionId:n,data:i}=c.payload;f(n,i)}):()=>{}}function kt(f){return ve.isAvailable()?ve.subscribe("session_ended",c=>{const{sessionId:n}=c.payload;f(n)}):()=>{}}function we(f){return Object.values(f).reduce((c,n)=>c+(n.unreadCount??0),0)}function He(f){return{...f,messages:f.messages??[],context:f.context??{},createdAt:f.createdAt??new Date,lastActivity:f.lastActivity??new Date,unreadCount:f.unreadCount??0}}function zt(){const f={sessions:{},activeSessionId:null,isConnected:!1,isTyping:!1,unreadCount:0,connectionStatus:ne.getConnectionStatus(),offlineMode:!navigator.onLine},{subscribe:c,set:n,update:i}=nt(f);return ne.on("connectionChange",e=>{i(o=>({...o,connectionStatus:e,isConnected:e.isOnline,offlineMode:!e.isOnline}))}),Tt((e,o)=>{i(d=>{const l=d.sessions[e];return l?{...d,sessions:{...d.sessions,[e]:{...l,...o,lastActivity:new Date}}}:d})}),kt(e=>{i(o=>({...o,sessions:{...o.sessions,[e]:{...o.sessions[e],status:"ended"}}}))}),{subscribe:c,setSessions:e=>{i(o=>{const d={...o.sessions};for(const l of e){const g=He(l),z=d[g.id];d[g.id]={...g,messages:z?.messages??g.messages,context:{...z?.context,...g.context},unreadCount:g.unreadCount??z?.unreadCount??0}}return{...o,sessions:d,unreadCount:we(d)}})},initializeSession:e=>{i(o=>{const d={id:e.sessionId,userId:e.userId,companyId:e.companyId,status:"active",createdAt:new Date,lastActivity:new Date,messages:[],unreadCount:0,context:{}};return We(e.sessionId,d),{...o,sessions:{...o.sessions,[e.sessionId]:d},activeSessionId:e.sessionId}})},setActiveSession:e=>{i(o=>{const d=o.sessions[e];if(!d)return{...o,activeSessionId:e};const l={...o.sessions,[e]:{...d,unreadCount:0}};return{...o,activeSessionId:e,sessions:l,unreadCount:we(l)}})},updateSession:(e,o)=>{i(d=>{const l=d.sessions[e];if(!l)return d;const g={...d.sessions,[e]:{...l,...o,context:{...l.context,...o.context},messages:o.messages??l.messages}};return{...d,sessions:g,unreadCount:we(g)}})},endSession:e=>{i(o=>({...o,sessions:{...o.sessions,[e]:{...o.sessions[e],status:"ended"}}})),Mt(e)},addMessage:(e,o=!0)=>{const d={...e,id:`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:new Date};return i(l=>{const g=l.sessions[e.sessionId]??He({id:e.sessionId,userId:"",companyId:"",status:"active",createdAt:new Date,lastActivity:new Date,messages:[],context:{}}),P=l.activeSessionId===e.sessionId?0:(g.unreadCount??0)+1,A={...g,messages:[...g.messages,d],lastActivity:new Date,lastMessage:d.content,unreadCount:P},O={...l.sessions,[e.sessionId]:A};return{...l,sessions:O,unreadCount:we(O)}}),o&&e.role==="user"&&ne.queueMessage("message",{session_id:e.sessionId,message:{role:e.role,content:e.content,metadata:e.metadata}}),d.id},sendMessage:async(e,o,d)=>{const l=F.addMessage({sessionId:e,role:"user",content:o,metadata:d},!1);try{if(ne.getConnectionStatus().isOnline){const g=await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:e,message:{role:"user",content:o,metadata:d}})});if(!g.ok)throw new Error(`HTTP ${g.status}: ${g.statusText}`)}else ne.queueMessage("message",{session_id:e,message:{role:"user",content:o,metadata:d}})}catch(g){console.error("Failed to send message:",g),ne.queueMessage("message",{session_id:e,message:{role:"user",content:o,metadata:d}})}return l},updateMessage:(e,o,d)=>{i(l=>{const g=l.sessions[e];return g?{...l,sessions:{...l.sessions,[e]:{...g,messages:g.messages.map(z=>z.id===o?{...z,...d}:z)}}}:l})},setConnectionState:e=>{i(o=>({...o,isConnected:e}))},setTypingState:e=>{i(o=>({...o,isTyping:e}))},updateSessionContext:(e,o)=>{i(d=>{const l=d.sessions[e];if(!l)return d;const g={...l.context,...o};return We(e,{context:g}),{...d,sessions:{...d.sessions,[e]:{...l,context:g,lastActivity:new Date}}}}),ne.queueMessage("session_update",{session_id:e,context:o})},updateCustomerInfo:(e,o)=>{i(d=>{const l=d.sessions[e];return l?{...d,sessions:{...d.sessions,[e]:{...l,context:{...l.context,customerInfo:{...l.context.customerInfo,...o}},lastActivity:new Date}}}:d}),ne.queueMessage("context_update",{session_id:e,customer_info:o})},clearUnreadCount:()=>{i(e=>({...e,unreadCount:0,sessions:Object.fromEntries(Object.entries(e.sessions).map(([o,d])=>[o,{...d,unreadCount:0}]))}))},markSessionRead:e=>{i(o=>{const d=o.sessions[e];if(!d)return o;const l={...o.sessions,[e]:{...d,unreadCount:0,lastActivity:new Date}};return{...o,sessions:l,unreadCount:we(l)}})},getOfflineStatus:()=>ne.getConnectionStatus(),getQueuedMessages:()=>ne.getQueuedMessages(),clearOfflineQueue:()=>ne.clearQueue()}}const F=zt(),Re=Ee(F,f=>f.activeSessionId?f.sessions[f.activeSessionId]:null),At=Ee(Re,f=>f?.messages||[]);Ee(F,f=>f.isConnected);var It=C('<pre class="mt-1 max-h-40 overflow-auto whitespace-pre-wrap text-[11px] leading-relaxed text-text-muted"> </pre>'),Ot=C('<div class="flex items-center justify-between gap-2"><span class="max-w-[220px] truncate"> </span> <span class="text-text-muted"> </span></div> <!>',1),jt=C('<div class="rounded-lg border border-divider-subtle bg-card px-3 py-2 text-xs text-text-secondary svelte-1soyxjk"></div>'),qt=C('<span class="font-medium"> </span>'),Dt=C("<span> </span>"),Et=C('<span class="rounded bg-tertiary px-1 py-0.5"> </span>'),Nt=C('<span class="rounded bg-tertiary px-1 py-0.5"> </span>'),Ft=C('<div><div class="flex-shrink-0"><div><!></div></div> <div><div><p class="text-sm leading-relaxed svelte-1soyxjk"> </p></div> <!> <div class="flex items-center gap-2 text-xs text-text-muted"><span> </span> <!> <!> <!> <!></div></div></div>'),Qt=C('<div class="flex flex-1 items-center justify-center text-text-muted"><div class="text-center"><!> <p class="text-sm">No messages yet. Start a conversation!</p></div></div>'),Rt=C('<div class="flex h-full flex-col space-y-4 overflow-y-auto p-4 svelte-1soyxjk"></div>');function Pt(f,c){he(c,!0);let n=Ce(c,"compact",3,!1),i,e=oe(!0);xe(()=>{const _=new MutationObserver(()=>{t(e)&&o()});return _.observe(i,{childList:!0,subtree:!0}),()=>_.disconnect()});function o(){i&&(i.scrollTop=i.scrollHeight)}function d(){if(i){const{scrollTop:_,scrollHeight:w,clientHeight:L}=i;q(e,_+L>=w-50)}}function l(_){return _.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function g(_){switch(_){case"user":return Le;case"assistant":return Pe;case"system":return bt;default:return Le}}function z(_){switch(_){case"user":return"bg-primary text-white";case"assistant":return"bg-secondary text-text-primary";case"system":return"bg-tertiary text-text-muted";default:return"bg-secondary text-text-primary"}}function P(_){const w=_.metadata?.attachments;return Array.isArray(w)?w:[]}function A(_){return _?_<1024?`${_} B`:_<1024*1024?`${Math.round(_/1024)} KB`:`${(_/(1024*1024)).toFixed(1)} MB`:""}var O=Rt();Se(O,21,()=>c.messages,_=>_.id,(_,w)=>{const L=de(()=>g(t(w).role)),G=de(()=>P(t(w)));var J=Ft();let U;var K=a(J),Y=a(K),X=a(Y);ot(X,()=>t(L),(x,S)=>{S(x,{class:"size-4"})}),s(Y),s(K);var W=v(K,2);let ae;var R=a(W),Z=a(R),y=a(Z,!0);s(Z),s(R);var D=v(R,2);{var H=x=>{var S=jt();Se(S,21,()=>t(G),Ne,(h,$)=>{var N=Ot(),Q=ge(N),ie=a(Q),le=a(ie,!0);s(ie);var me=v(ie,2),pe=a(me,!0);s(me),s(Q);var fe=v(Q,2);{var Te=ue=>{var ye=It(),ke=a(ye,!0);s(ye),j(()=>k(ke,t($).text)),b(ue,ye)};E(fe,ue=>{t($).text&&ue(Te)})}j(ue=>{k(le,t($).name),k(pe,ue)},[()=>A(t($).size)]),b(h,N)}),s(S),b(x,S)};E(D,x=>{t(G).length>0&&x(H)})}var te=v(D,2),re=a(te),V=a(re,!0);s(re);var T=v(re,2);{var u=x=>{var S=qt(),h=a(S,!0);s(S),j(()=>k(h,t(w).metadata.provider)),b(x,S)};E(T,x=>{t(w).metadata?.provider&&x(u)})}var m=v(T,2);{var r=x=>{var S=Dt(),h=a(S);s(S),j($=>k(h,`${$??""}% confidence`),[()=>Math.round(t(w).metadata.confidence*100)]),b(x,S)};E(m,x=>{t(w).metadata?.confidence&&x(r)})}var p=v(m,2);{var M=x=>{var S=Et(),h=a(S,!0);s(S),j(()=>k(h,t(w).metadata.intent)),b(x,S)};E(p,x=>{t(w).metadata?.intent&&x(M)})}var I=v(p,2);{var B=x=>{var S=Nt(),h=a(S,!0);s(S),j(()=>k(h,t(w).metadata.sentiment)),b(x,S)};E(I,x=>{t(w).metadata?.sentiment&&x(B)})}s(te),s(W),s(J),j((x,S)=>{U=ce(J,1,`flex gap-3 ${t(w).role==="user"?"flex-row-reverse":"flex-row"}`,"svelte-1soyxjk",U,{compact:n()}),ce(Y,1,`flex size-8 items-center justify-center rounded-full ${x??""}`,"svelte-1soyxjk"),ae=ce(W,1,"flex max-w-[70%] flex-col gap-1",null,ae,{"text-right":t(w).role==="user"}),ce(R,1,`rounded-2xl px-4 py-2 ${t(w).role==="user"?"bg-primary text-white":"bg-secondary text-text-primary"}`,"svelte-1soyxjk"),k(y,t(w).content),k(V,S)},[()=>z(t(w).role),()=>l(t(w).timestamp)]),b(_,J)},_=>{var w=Qt(),L=a(w),G=a(L);Pe(G,{class:"mx-auto mb-2 size-8 text-text-muted"}),je(2),s(L),s(w),b(_,w)}),s(O),Ae(O,_=>i=_,()=>i),st("scroll",O,d),b(f,O),_e()}var Lt=C('<p class="mt-2 text-xs text-red-500"> </p>'),Ut=C('<div class="flex items-center gap-2 rounded-lg border border-divider bg-card px-2 py-1 text-xs text-text-secondary"><span class="max-w-[180px] truncate"> </span> <span class="text-text-muted"> </span> <button class="text-text-muted hover:text-text-primary" title="Remove attachment" type="button"><!></button></div>'),Wt=C('<div class="mt-2 flex flex-wrap gap-2"></div>'),Ht=C('<div class="flex items-end gap-3"><button class="flex size-10 items-center justify-center rounded-lg text-text-secondary hover:bg-secondary-hover disabled:opacity-50" title="Attach file"><!></button> <input type="file" class="hidden" multiple/> <div class="flex-1"><textarea class="w-full resize-none border-2 border-divider bg-background px-4 py-3 text-sm placeholder-text-muted focus:outline-none disabled:opacity-50 shadow-card svelte-j7h4bp" rows="1" style="max-height: 120px; min-height: 44px;"></textarea> <!> <!></div> <button class="inline-flex size-10 items-center justify-center border-2 border-divider bg-card text-text-secondary shadow-card disabled:opacity-50"><!></button> <button class="inline-flex size-10 items-center justify-center border-2 border-divider bg-primary text-primary-foreground shadow-card disabled:opacity-50" title="Send message"><!></button></div>');function Bt(f,c){he(c,!0);const n=2*1024*1024,i=4e3,e=/\.(txt|md|csv|json|log)$/i;let o=Ce(c,"disabled",3,!1),d=Ce(c,"placeholder",3,"Type your message..."),l=oe(""),g=oe(!1),z=oe(ze([])),P=oe(ze([])),A,O;xe(()=>{A&&(A.style.height="auto",A.style.height=A.scrollHeight+"px")});function _(){A&&(A.style.height="auto",A.style.height=Math.min(A.scrollHeight,120)+"px")}function w(r){r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),L())}async function L(){const r=t(l).trim();if(r===""&&t(z).length===0||o())return;const p=t(z).map(x=>x.payload),M=p.length>0?{attachments:p}:void 0,I=p.map(x=>x.name).join(", "),B=r||`Attached file${p.length===1?"":"s"}: ${I}`;await c.onSendMessage(B,M),q(l,""),q(z,[],!0),q(P,[],!0),A&&(A.style.height="auto")}function G(){o()||O?.click()}async function J(r){if(o())return;const p=r.currentTarget,M=Array.from(p.files??[]),I=[],B=[];for(const x of M){if(x.size>n){B.push(`${x.name} is larger than 2 MB.`);continue}let S;if(x.type.startsWith("text/")||e.test(x.name))try{const h=await x.text();S=h.length>i?`${h.slice(0,i)}...`:h}catch(h){console.error("Failed to read file",h)}I.push({file:x,payload:{name:x.name,size:x.size,type:x.type||"application/octet-stream",text:S}})}q(z,[...t(z),...I],!0),q(P,B,!0),p.value=""}function U(r){q(z,t(z).filter((p,M)=>M!==r),!0)}function K(r){return r<1024?`${r} B`:r<1024*1024?`${Math.round(r/1024)} KB`:`${(r/(1024*1024)).toFixed(1)} MB`}function Y(){t(g)?(q(g,!1),console.log("Recording stopped")):(q(g,!0),console.log("Recording started"))}var X=Ht(),W=a(X);W.__click=G;var ae=a(W);wt(ae,{class:"size-5"}),s(W);var R=v(W,2);R.__change=J,Ae(R,r=>O=r,()=>O);var Z=v(R,2),y=a(Z);Ze(y),y.__input=_,y.__keydown=w,Ae(y,r=>A=r,()=>A);var D=v(y,2);{var H=r=>{var p=Lt(),M=a(p,!0);s(p),j(I=>k(M,I),[()=>t(P).join(" ")]),b(r,p)};E(D,r=>{t(P).length>0&&r(H)})}var te=v(D,2);{var re=r=>{var p=Wt();Se(p,21,()=>t(z),Ne,(M,I,B)=>{var x=Ut(),S=a(x),h=a(S,!0);s(S);var $=v(S,2),N=a($,!0);s($);var Q=v($,2);Q.__click=()=>U(B);var ie=a(Q);dt(ie,{class:"size-3"}),s(Q),s(x),j(le=>{k(h,t(I).payload.name),k(N,le)},[()=>K(t(I).payload.size)]),b(M,x)}),s(p),b(r,p)};E(te,r=>{t(z).length>0&&r(re)})}s(Z);var V=v(Z,2);V.__click=Y;var T=a(V);{let r=de(()=>t(g)?"text-red-500":"");ct(T,{get class(){return`size-5 ${t(r)??""}`}})}s(V);var u=v(V,2);u.__click=L;var m=a(u);St(m,{class:"size-5"}),s(u),s(X),j(r=>{W.disabled=o(),R.disabled=o(),Ue(y,"placeholder",d()),y.disabled=o(),V.disabled=o(),Ue(V,"title",t(g)?"Stop recording":"Start recording"),u.disabled=r},[()=>o()||!t(l).trim()&&t(z).length===0]),Ke(y,()=>t(l),r=>q(l,r)),b(f,X),_e()}Me(["click","change","input","keydown"]);var Jt=C("<button> </button>"),Kt=C('<span class="flex size-5 items-center justify-center rounded-full bg-primary text-xs text-white"> </span>'),Xt=C('<span class="rounded bg-tertiary px-2 py-0.5 text-xs text-text-muted"> </span>'),Vt=C('<button class="rounded bg-tertiary px-2 py-0.5 text-xs text-text-muted hover:bg-secondary-hover" title="Go to voice session"><!></button>'),Gt=C('<div><div class="flex size-10 flex-shrink-0 items-center justify-center rounded-full bg-primary text-white"><!></div> <div class="flex-1 min-w-0"><div class="flex items-center justify-between gap-2"><h4 class="truncate text-sm font-medium text-text-primary"> </h4> <span class="text-xs text-text-muted"> </span></div> <div class="mt-1 flex items-center justify-between gap-2"><p class="truncate text-xs text-text-secondary"> </p> <!></div> <div class="mt-2 flex items-center gap-2"><span> </span> <!> <!></div></div></div>'),Yt=C('<div class="flex flex-1 items-center justify-center p-8 text-center"><!> <p class="text-sm text-text-muted"> </p></div>'),Zt=C('<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"><div class="w-full max-w-md rounded-xl bg-background p-6 shadow-card"><h3 class="mb-4 text-lg font-semibold text-text-primary">Start New Chat Session</h3> <p class="mb-6 text-sm text-text-secondary">Create a new chat session to start assisting customers.</p> <div class="flex gap-3"><button class="flex-1 rounded-lg bg-primary px-4 py-2 text-sm font-medium text-white hover:bg-primary/90">Create Session</button> <button class="flex-1 rounded-lg border border-divider-subtle px-4 py-2 text-sm font-medium text-text-secondary hover:bg-secondary-hover">Cancel</button></div></div></div>'),es=C('<div class="flex h-full flex-col bg-background"><div class="border-b border-divider-subtle p-4"><div class="mb-4 flex items-center justify-between"><h3 class="text-lg font-semibold text-text-primary">Chat Sessions</h3> <button class="flex size-8 items-center justify-center rounded-lg bg-primary text-white hover:bg-primary/90" title="New session"><!></button></div> <div class="relative mb-3"><!> <input type="text" placeholder="Search sessions..." class="w-full rounded-lg border border-divider-subtle bg-background pl-10 pr-4 py-2 text-sm placeholder-text-muted focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"/></div> <div class="flex gap-2"></div></div> <div class="flex-1 overflow-y-auto svelte-fhtucl"></div> <div class="border-t border-divider-subtle p-4"><button class="flex w-full items-center justify-center gap-2 rounded-lg px-4 py-2 text-sm text-text-secondary hover:bg-secondary-hover"><!> Chat Settings</button></div></div> <!>',1);function ts(f,c){he(c,!0);const n=()=>$e(F,"$chatStore",e),i=()=>$e(Re,"$activeSession",e),[e,o]=Je();let d=oe(!1),l=oe(""),g=oe("all"),z=de(()=>Object.values(n().sessions));xe(()=>{P()});async function P(){try{const m=(await at("/api/chat/sessions")).sessions.map(r=>{const p=r.context??{},M=r.last_activity??r.created_at,I=M?new Date(M):new Date,B=r.customer_info?.name||p.customer_name||p.customerName||"Unknown Customer";return{id:r.id,userId:r.user_id??"",companyId:r.company_id??"",customerName:B,lastMessage:r.last_message??"",unreadCount:r.unread_count??0,createdAt:r.created_at?new Date(r.created_at):I,lastActivity:I,status:r.status==="active"?"active":"ended",provider:r.provider??"",context:{voiceSessionId:p.voiceSessionId||p.voice_session_id,campaign:p.campaign,customerInfo:r.customer_info},messages:[]}});F.setSessions(m)}catch(u){console.error("Failed to load sessions",u)}}function A(){const u=`session_${Date.now()}`;F.initializeSession({sessionId:u,userId:"user_123",companyId:"company_456"}),F.setActiveSession(u),F.updateSession(u,{customerName:"New Customer",lastMessage:"Session started",provider:"gemini",lastActivity:new Date,unreadCount:0}),q(d,!1)}async function O(u){F.setActiveSession(u),F.markSessionRead(u);try{await rt(`/api/chat/sessions/${u}/read`,{})}catch(m){console.error("Failed to mark session as read",m)}}function _(u){if(!u)return;const m=new URLSearchParams({voice_session_id:u});lt(`/calls/agent?${m.toString()}`)}function w(u){const r=new Date().getTime()-u.getTime(),p=Math.floor(r/(1e3*60)),M=Math.floor(r/(1e3*60*60)),I=Math.floor(r/(1e3*60*60*24));return p<1?"Just now":p<60?`${p}m ago`:M<24?`${M}h ago`:I<7?`${I}d ago`:u.toLocaleDateString()}function L(u){switch(u){case"active":return"bg-green-100 text-green-800";case"ended":return"bg-gray-100 text-gray-800";default:return"bg-gray-100 text-gray-800"}}const G=de(()=>t(z).slice().sort((u,m)=>m.lastActivity.getTime()-u.lastActivity.getTime()).filter(u=>{const m=u.customerName??"Unknown Customer",r=u.lastMessage??"",p=m.toLowerCase().includes(t(l).toLowerCase())||r.toLowerCase().includes(t(l).toLowerCase()),M=t(g)==="all"||u.status===t(g);return p&&M}));var J=es(),U=ge(J),K=a(U),Y=a(K),X=v(a(Y),2);X.__click=()=>q(d,!0);var W=a(X);ut(W,{class:"size-4"}),s(X),s(Y);var ae=v(Y,2),R=a(ae);vt(R,{class:"absolute left-3 top-1/2 size-4 -translate-y-1/2 text-text-muted"});var Z=v(R,2);it(Z),s(ae);var y=v(ae,2);Se(y,20,()=>["all","active","ended"],Ne,(u,m)=>{const r=de(()=>m);var p=Jt();p.__click=()=>q(g,t(r),!0);var M=a(p,!0);s(p),j(()=>{ce(p,1,`rounded-lg px-3 py-1 text-xs font-medium capitalize ${t(g)===t(r)?"bg-primary text-white":"bg-secondary text-text-secondary hover:bg-secondary-hover"}`),k(M,m)}),b(u,p)}),s(y),s(K);var D=v(K,2);Se(D,21,()=>t(G),u=>u.id,(u,m)=>{var r=Gt();r.__click=()=>O(t(m).id);var p=a(r),M=a(p);Ie(M,{class:"size-5"}),s(p);var I=v(p,2),B=a(I),x=a(B),S=a(x,!0);s(x);var h=v(x,2),$=a(h,!0);s(h),s(B);var N=v(B,2),Q=a(N),ie=a(Q,!0);s(Q);var le=v(Q,2);{var me=se=>{var ee=Kt(),be=a(ee,!0);s(ee),j(()=>k(be,t(m).unreadCount)),b(se,ee)};E(le,se=>{(t(m).unreadCount??0)>0&&se(me)})}s(N);var pe=v(N,2),fe=a(pe),Te=a(fe,!0);s(fe);var ue=v(fe,2);{var ye=se=>{var ee=Xt(),be=a(ee,!0);s(ee),j(()=>k(be,t(m).provider)),b(se,ee)};E(ue,se=>{t(m).provider&&se(ye)})}var ke=v(ue,2);{var Ge=se=>{var ee=Vt();ee.__click=Ye=>{Ye.stopPropagation(),_(t(m).context?.voiceSessionId)};var be=a(ee);pt(be,{class:"inline size-3"}),s(ee),b(se,ee)};E(ke,se=>{t(m).context?.voiceSessionId&&se(Ge)})}s(pe),s(I),s(r),j((se,ee)=>{ce(r,1,`flex cursor-pointer gap-3 border-b border-divider-subtle p-4 hover:bg-secondary-hover ${i()?.id===t(m).id?"bg-secondary-hover":""}`),k(S,t(m).customerName??"Unknown Customer"),k($,se),k(ie,t(m).lastMessage??""),ce(fe,1,`rounded-full px-2 py-0.5 text-xs font-medium ${ee??""}`,"svelte-fhtucl"),k(Te,t(m).status)},[()=>w(t(m).lastActivity),()=>L(t(m).status)]),b(u,r)},u=>{var m=Yt(),r=a(m);Ie(r,{class:"mx-auto mb-2 size-8 text-text-muted"});var p=v(r,2),M=a(p,!0);s(p),s(m),j(()=>k(M,t(l)?"No sessions found":"No sessions yet")),b(u,m)}),s(D);var H=v(D,2),te=a(H),re=a(te);Xe(re,{class:"size-4"}),je(),s(te),s(H),s(U);var V=v(U,2);{var T=u=>{var m=Zt(),r=a(m),p=v(a(r),4),M=a(p);M.__click=A;var I=v(M,2);I.__click=()=>q(d,!1),s(p),s(r),s(m),b(u,m)};E(V,u=>{t(d)&&u(T)})}Ke(Z,()=>t(l),u=>q(l,u)),b(f,J),_e(),o()}Me(["click"]);var ss=C('<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full svelte-pz4xm9"> </span>'),ns=C('<div class="flex items-center justify-between text-sm svelte-pz4xm9"><span class="text-gray-600 svelte-pz4xm9">Last connected:</span> <span class="font-medium svelte-pz4xm9"> </span></div>'),as=C('<div class="flex items-center justify-between text-sm svelte-pz4xm9"><span class="text-gray-600 svelte-pz4xm9">Reconnect attempts:</span> <span class="font-medium svelte-pz4xm9"> </span></div>'),rs=C('<div class="flex items-center justify-between text-sm svelte-pz4xm9"><span class="text-gray-600 svelte-pz4xm9">Queued messages:</span> <span class="font-medium text-yellow-600 svelte-pz4xm9"> </span></div> <div class="bg-yellow-50 border border-yellow-200 rounded-md p-2 svelte-pz4xm9"><div class="flex items-start gap-2 svelte-pz4xm9"><!> <p class="text-xs text-yellow-800 svelte-pz4xm9">Messages will be sent automatically when connection is restored.</p></div></div>',1),os=C('<button class="flex-1 bg-blue-600 text-white text-sm px-3 py-1.5 rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50 svelte-pz4xm9"> </button>'),is=C('<button class="flex-1 bg-gray-600 text-white text-sm px-3 py-1.5 rounded-md hover:bg-gray-700 transition-colors svelte-pz4xm9">Clear Queue</button>'),cs=C('<div class="border-t border-gray-200 p-3 space-y-2 svelte-pz4xm9"><div class="flex items-center justify-between text-sm svelte-pz4xm9"><span class="text-gray-600 svelte-pz4xm9">Status:</span> <span> </span></div> <!> <!> <!> <div class="flex gap-2 pt-2 svelte-pz4xm9"><!> <!></div></div>'),ds=C('<div class="fixed bottom-4 right-4 z-50 svelte-pz4xm9"><div><div class="flex items-center gap-2 p-3 cursor-pointer hover:bg-gray-50 transition-colors svelte-pz4xm9"><div class="relative svelte-pz4xm9"><!> <div></div></div> <span class="font-medium text-sm svelte-pz4xm9"> </span> <div class="flex-1 svelte-pz4xm9"></div> <!> <!></div> <!></div></div>');function Ve(f,c){he(c,!0);let n=oe(ze(ne.getConnectionStatus())),i=oe(!1),e=oe(!1),o,d;xe(()=>{d=F.subscribe(y=>{q(n,y.connectionStatus,!0)})}),Be(()=>{d&&d(),o&&clearTimeout(o)}),et(()=>(t(n).isOnline&&t(n).queuedMessages===0?o=setTimeout(()=>{q(i,!1)},3e3):(clearTimeout(o),q(i,!0)),()=>clearTimeout(o)));async function l(){q(e,!0);try{window.location.reload()}finally{q(e,!1)}}function g(){return t(n).isOnline?t(n).queuedMessages>0?"bg-yellow-500":"bg-green-500":"bg-red-500"}function z(){return t(n).isOnline?t(n).queuedMessages>0?`${t(n).queuedMessages} queued`:"Online":"Offline"}var P=ds(),A=a(P),O=a(A);O.__click=()=>q(i,!t(i));var _=a(O),w=a(_);{var L=y=>{ht(y,{class:"w-5 h-5 text-green-600"})},G=y=>{_t(y,{class:"w-5 h-5 text-red-600"})};E(w,y=>{t(n).isOnline?y(L):y(G,!1)})}var J=v(w,2);let U;s(_);var K=v(_,2),Y=a(K,!0);s(K);var X=v(K,4);{var W=y=>{var D=ss(),H=a(D,!0);s(D),j(()=>k(H,t(n).queuedMessages)),b(y,D)};E(X,y=>{t(n).queuedMessages>0&&y(W)})}var ae=v(X,2);{let y=de(()=>t(e)?"animate-spin":"");gt(ae,{get class(){return`w-4 h-4 text-gray-400 transition-transform ${t(y)??""}`}})}s(O);var R=v(O,2);{var Z=y=>{var D=cs(),H=a(D),te=v(a(H),2),re=a(te,!0);s(te),s(H);var V=v(H,2);{var T=h=>{var $=ns(),N=v(a($),2),Q=a(N,!0);s(N),s($),j(ie=>k(Q,ie),[()=>new Date(t(n).lastConnected).toLocaleTimeString()]),b(h,$)};E(V,h=>{t(n).lastConnected&&h(T)})}var u=v(V,2);{var m=h=>{var $=as(),N=v(a($),2),Q=a(N,!0);s(N),s($),j(()=>k(Q,t(n).reconnectAttempts)),b(h,$)};E(u,h=>{t(n).reconnectAttempts>0&&h(m)})}var r=v(u,2);{var p=h=>{var $=rs(),N=ge($),Q=v(a(N),2),ie=a(Q,!0);s(Q),s(N);var le=v(N,2),me=a(le),pe=a(me);mt(pe,{class:"w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0"}),je(2),s(me),s(le),j(()=>k(ie,t(n).queuedMessages)),b(h,$)};E(r,h=>{t(n).queuedMessages>0&&h(p)})}var M=v(r,2),I=a(M);{var B=h=>{var $=os();$.__click=l;var N=a($,!0);s($),j(()=>{$.disabled=t(e),k(N,t(e)?"Reconnecting...":"Reconnect")}),b(h,$)};E(I,h=>{t(n).isOnline||h(B)})}var x=v(I,2);{var S=h=>{var $=is();$.__click=()=>ne.clearQueue(),b(h,$)};E(x,h=>{t(n).queuedMessages>0&&h(S)})}s(M),s(D),j(()=>{ce(te,1,`font-medium ${t(n).isOnline?"text-green-600":"text-red-600"}`,"svelte-pz4xm9"),k(re,t(n).isOnline?"Connected":"Disconnected")}),b(y,D)};E(R,y=>{t(i)&&y(Z)})}s(A),s(P),j((y,D)=>{ce(A,1,`bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden transition-all duration-300 ${t(i)?"w-80":"w-auto"}`,"svelte-pz4xm9"),U=ce(J,1,`absolute -top-1 -right-1 w-3 h-3 rounded-full ${y??""}`,"svelte-pz4xm9",U,{"animate-pulse":!t(n).isOnline||t(n).queuedMessages>0}),k(Y,D)},[g,z]),ft(3,A,()=>xt,()=>({y:20,duration:300})),b(f,P),_e()}Me(["click"]);var ls=C('<div class="w-80 flex-shrink-0"><!></div>'),us=C('<div class="flex h-full gap-4"><!> <div class="flex flex-1 flex-col"><div class="flex items-center justify-between border-b border-divider-subtle bg-background px-6 py-4"><div class="flex items-center gap-3"><button class="rounded-lg p-2 text-text-secondary hover:bg-secondary-hover md:hidden" title="Toggle sidebar"><!></button> <div class="flex items-center gap-2"><!> <h2 class="text-lg font-semibold text-text-primary"> </h2></div></div> <div class="flex items-center gap-3"><!> <button class="rounded-lg p-2 text-text-secondary hover:bg-secondary-hover" title="Chat settings"><!></button></div></div> <div class="flex-1 overflow-hidden svelte-10hnnxw"><!></div> <div class="border-t border-divider-subtle bg-background p-4"><!></div></div></div>');function vs(f,c){he(c,!0);const n=()=>$e(Re,"$activeSession",e),i=()=>$e(At,"$activeMessages",e),[e,o]=Je();let d=oe(!0),l=null;xe(()=>{g()}),Be(()=>{l&&l.close()});function g(){const u=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/api/chat/ws`;l=new WebSocket(u),l.onopen=()=>{F.setConnectionState(!0),console.log("Chat WebSocket connected")},l.onmessage=m=>{try{const r=JSON.parse(m.data);z(r)}catch(r){console.error("Error parsing WebSocket message:",r)}},l.onclose=()=>{F.setConnectionState(!1),console.log("Chat WebSocket disconnected"),setTimeout(g,3e3)},l.onerror=m=>{console.error("Chat WebSocket error:",m),F.setConnectionState(!1)}}function z(T){switch(T.type){case"message":F.addMessage({sessionId:T.sessionId,role:T.role,content:T.content,metadata:T.metadata});break;case"typing":F.setTypingState(T.isTyping);break;case"session_update":F.updateSessionContext(T.sessionId,T.context);break;default:console.log("Unknown WebSocket message type:",T.type)}}async function P(T,u){const m=n()?.id;if(!m){console.error("No active session");return}try{await F.sendMessage(m,T,u)}catch(r){console.error("Failed to send message:",r)}l&&l.readyState===WebSocket.OPEN&&l.send(JSON.stringify({type:"message",sessionId:m,content:T,metadata:u}))}function A(){q(d,!t(d))}var O=us(),_=a(O);{var w=T=>{var u=ls(),m=a(u);ts(m,{}),s(u),b(T,u)};E(_,T=>{t(d)&&T(w)})}var L=v(_,2),G=a(L),J=a(G),U=a(J);U.__click=A;var K=a(U);Ie(K,{class:"size-5"}),s(U);var Y=v(U,2),X=a(Y);yt(X,{class:"size-5 text-primary"});var W=v(X,2),ae=a(W,!0);s(W),s(Y),s(J);var R=v(J,2),Z=a(R);Ve(Z,{});var y=v(Z,2),D=a(y);Xe(D,{class:"size-5"}),s(y),s(R),s(G);var H=v(G,2),te=a(H);Pt(te,{get messages(){return i()}}),s(H);var re=v(H,2),V=a(re);{let T=de(()=>!n()),u=de(()=>n()?"Type your message...":"No active session");Bt(V,{onSendMessage:P,get disabled(){return t(T)},get placeholder(){return t(u)}})}s(re),s(L),s(O),j(T=>k(ae,T),[()=>n()?`Chat Session ${n().id.slice(-8)}`:"No Active Session"]),b(f,O),_e(),o()}Me(["click"]);var ms=C('<div class="flex h-full flex-col"><div class="mb-4"><h1 class="text-2xl font-bold text-text-primary">Web Chat</h1> <p class="text-text-secondary">AI-powered customer engagement</p></div> <!> <!></div>');function Xs(f,c){he(c,!1);let n=Ce(c,"data",8);xe(()=>{F.initializeSession({sessionId:n().sessionId,userId:n().userId,companyId:n().companyId})}),tt();var i=ms(),e=v(a(i),2);vs(e,{});var o=v(e,2);Ve(o,{}),s(i),b(f,i),_e()}export{Xs as component,Ks as universal};
