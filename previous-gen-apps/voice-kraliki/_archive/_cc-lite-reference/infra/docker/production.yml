# Voice by Kraliki Production Docker Compose Configuration
# ================================================
# Consolidated, Security-Hardened, Production-Ready Configuration
# Following Stack 2025 and Truth-Driven Development Principles
#
# Build Command: docker compose -f docker-compose.production.yml up -d
# Health Check: docker compose -f docker-compose.production.yml ps
# Logs: docker compose -f docker-compose.production.yml logs -f
#
# SECURITY COMPLIANCE:
# ✅ Docker secrets for sensitive data
# ✅ Non-root users for all services
# ✅ Resource limits and security hardening
# ✅ Container networking with service names
# ✅ Comprehensive health checks
# ✅ Zero-downtime deployment ready

# Docker Compose v2 - version field is obsolete

# ==============================================================================
# DOCKER SECRETS - MANDATORY FOR PRODUCTION
# ==============================================================================
# Create secrets before deployment:
# echo "your_jwt_secret_here" | docker secret create cc_lite_jwt_secret -
# echo "your_db_password_here" | docker secret create cc_lite_db_password -
# echo "your_redis_password_here" | docker secret create cc_lite_redis_password -

secrets:
  cc_lite_jwt_secret:
    external: true
  cc_lite_jwt_refresh_secret:
    external: true
  cc_lite_db_password:
    external: true
  cc_lite_redis_password:
    external: true
  cc_lite_session_secret:
    external: true
  cc_lite_cookie_secret:
    external: true
  cc_lite_twilio_auth_token:
    external: true
  cc_lite_openai_api_key:
    external: true
  cc_lite_deepgram_api_key:
    external: true

# ==============================================================================
# SERVICES
# ==============================================================================
services:
  # PostgreSQL Database - Production Optimized
  postgres:
    image: postgres:15-alpine
    container_name: voice-kraliki-postgres-prod
    restart: unless-stopped
    user: postgres
    environment:
      POSTGRES_DB: cc_light_prod
      POSTGRES_USER: cc_lite_user
      POSTGRES_PASSWORD_FILE: /run/secrets/cc_lite_db_password
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256 --auth-local=scram-sha-256"
      PGDATA: /var/lib/postgresql/data/pgdata
    secrets:
      - cc_lite_db_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_backups:/var/lib/postgresql/backups
      - /etc/localtime:/etc/localtime:ro
    networks:
      - cc_lite_internal
    ports:
      # CRITICAL: Use 127.0.0.1 binding for security (BSI compliance)
      - "127.0.0.1:5433:5432"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cc_lite_user -d cc_light_prod"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETUID
      - SETGID
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=512MB
      -c effective_cache_size=1536MB
      -c maintenance_work_mem=128MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=32MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=8MB
      -c min_wal_size=2GB
      -c max_wal_size=8GB
      -c max_worker_processes=8
      -c max_parallel_workers_per_gather=4
      -c max_parallel_workers=8
      -c log_statement=error
      -c log_min_error_statement=error
      -c log_checkpoints=on
      -c log_connections=on
      -c log_disconnections=on
      -c log_lock_waits=on
      -c log_temp_files=0
      -c temp_file_limit=1GB
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        labels: "service=voice-kraliki-postgres"

  # Redis Cache & Session Store - Production Optimized
  redis:
    image: redis:7-alpine
    container_name: voice-kraliki-redis-prod
    restart: unless-stopped
    user: redis
    environment:
      REDIS_PASSWORD_FILE: /run/secrets/cc_lite_redis_password
    secrets:
      - cc_lite_redis_password
    volumes:
      - redis_data:/data
      - /etc/localtime:/etc/localtime:ro
    networks:
      - cc_lite_internal
    ports:
      # CRITICAL: Use 127.0.0.1 binding for security (BSI compliance)
      - "127.0.0.1:6380:6379"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    command: >
      sh -c "
      export REDIS_PASSWORD=$$(cat /run/secrets/cc_lite_redis_password) &&
      redis-server
      --requirepass $$REDIS_PASSWORD
      --maxmemory 768mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
      --appendonly yes
      --appendfsync everysec
      --tcp-keepalive 300
      --timeout 0
      --tcp-backlog 511
      --databases 16
      --stop-writes-on-bgsave-error yes
      --rdbcompression yes
      --rdbchecksum yes
      --bind 0.0.0.0
      --protected-mode yes
      --port 6379
      "
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        labels: "service=voice-kraliki-redis"

  # Voice by Kraliki Application - Main Service
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NODE_ENV: production
        BUILDTIME: ${BUILDTIME:-unknown}
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
    image: voice-kraliki-app:${IMAGE_TAG:-latest}
    container_name: voice-kraliki-app-prod
    restart: unless-stopped
    user: "1001:1001"
    environment:
      # Core Application Settings
      NODE_ENV: production
      HOST: 0.0.0.0  # Bind to all interfaces within container
      PORT: 3010
      FRONTEND_PORT: 3007
      FRONTEND_URL: http://localhost:3007

      # Database Connection (using service name)
      DATABASE_URL: postgresql://cc_lite_user@postgres:5432/cc_light_prod?schema=public

      # Redis Connection (using service name)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_URL: redis://redis:6379

      # Security Settings
      SESSION_SECURE: "true"
      COOKIE_SECURE: "true"
      COOKIE_SAME_SITE: "strict"
      CORS_ORIGIN: ${CORS_ORIGIN:-https://voice-kraliki.yourdomain.com}

      # Application Features
      TELEPHONY_ENABLED: "true"
      TELEPHONY_PROVIDER: ${TELEPHONY_PROVIDER:-twilio}
      ENABLE_LANGUAGE_DETECTION: "true"
      DEFAULT_LANGUAGE: ${DEFAULT_LANGUAGE:-en}
      SUPPORTED_LANGUAGES: ${SUPPORTED_LANGUAGES:-en,es,cs}

      # Monitoring & Observability
      LOG_LEVEL: info
      LOG_FORMAT: json
      METRICS_ENABLED: "true"
      TRACING_ENABLED: "true"
      HEALTH_CHECK_ENABLED: "true"
      SENTRY_DSN: ${SENTRY_DSN:-}

      # Production Security
      SEED_DEMO_USERS: "false"
      ENABLE_DEBUG_LOGGING: "false"
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-900000}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS:-100}

      # External Service Configuration
      WEBHOOK_BASE_URL: ${WEBHOOK_BASE_URL:-https://voice-kraliki.yourdomain.com}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_PHONE_NUMBER: ${TWILIO_PHONE_NUMBER:-}

      # Stack 2025 Requirements
      LINEAR_API_KEY: ${LINEAR_API_KEY:-}
      LINEAR_TEAM_ID: ${LINEAR_TEAM_ID:-}
      APP_ENV: production

      # Multi-Language Configuration
      CZECH_LANGUAGE_ENABLED: ${CZECH_LANGUAGE_ENABLED:-true}
      SPANISH_LANGUAGE_ENABLED: ${SPANISH_LANGUAGE_ENABLED:-true}
      ENGLISH_LANGUAGE_ENABLED: ${ENGLISH_LANGUAGE_ENABLED:-true}

      # Performance Tuning
      NODE_OPTIONS: "--max-old-space-size=1024 --enable-source-maps"
      UV_THREADPOOL_SIZE: 16

    secrets:
      - cc_lite_jwt_secret
      - cc_lite_jwt_refresh_secret
      - cc_lite_db_password
      - cc_lite_redis_password
      - cc_lite_session_secret
      - cc_lite_cookie_secret
      - cc_lite_twilio_auth_token
      - cc_lite_openai_api_key
      - cc_lite_deepgram_api_key
    volumes:
      - app_logs:/app/logs
      - app_uploads:/app/uploads
      - /etc/localtime:/etc/localtime:ro
    networks:
      - cc_lite_internal
      - cc_lite_external
    ports:
      # CRITICAL: Use 127.0.0.1 binding for security (BSI compliance)
      - "127.0.0.1:3007:3007"  # Frontend
      - "127.0.0.1:3010:3010"  # Backend API
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '2.0'
          memory: 2G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3010/health"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    read_only: true
    tmpfs:
      - /tmp:size=200M,mode=1777,exec,suid
      - /app/tmp:size=500M,mode=1777,exec,suid
      - /app/.cache:size=100M,mode=1777
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "10"
        labels: "service=voice-kraliki-app"

  # Nginx Reverse Proxy & SSL Termination
  nginx:
    image: nginx:1.25-alpine
    container_name: voice-kraliki-nginx-prod
    restart: unless-stopped
    user: nginx
    volumes:
      - ./deploy/nginx/nginx.prod.conf:/etc/nginx/nginx.conf:ro
      - ./deploy/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./deploy/ssl:/etc/ssl/private:ro
      - nginx_cache:/var/cache/nginx
      - nginx_logs:/var/log/nginx
      - /etc/localtime:/etc/localtime:ro
    networks:
      - cc_lite_external
    ports:
      # External facing - production traffic
      - "80:80"
      - "443:443"
    depends_on:
      app:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/nginx-health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    read_only: true
    tmpfs:
      - /var/run:size=100M,mode=0755
      - /tmp:size=50M,mode=1777
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        labels: "service=voice-kraliki-nginx"

  # Monitoring - Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: voice-kraliki-prometheus-prod
    restart: unless-stopped
    user: "65534:65534"  # nobody user
    volumes:
      - ./deploy/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./deploy/monitoring/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus
      - /etc/localtime:/etc/localtime:ro
    networks:
      - cc_lite_internal
    ports:
      # CRITICAL: Use 127.0.0.1 binding for security
      - "127.0.0.1:9090:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
      - '--storage.tsdb.wal-compression'
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        labels: "service=voice-kraliki-prometheus"

  # Monitoring - Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: voice-kraliki-grafana-prod
    restart: unless-stopped
    user: "472:472"  # grafana user
    environment:
      GF_SECURITY_ADMIN_PASSWORD_FILE: /run/secrets/cc_lite_session_secret
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SECURITY_DISABLE_GRAVATAR: "true"
      GF_ANALYTICS_REPORTING_ENABLED: "false"
      GF_ANALYTICS_CHECK_FOR_UPDATES: "false"
      GF_INSTALL_PLUGINS: grafana-piechart-panel,grafana-clock-panel
      GF_SERVER_DOMAIN: ${GRAFANA_DOMAIN:-localhost}
      GF_SERVER_ROOT_URL: https://${GRAFANA_DOMAIN:-localhost}/grafana/
    secrets:
      - cc_lite_session_secret
    volumes:
      - grafana_data:/var/lib/grafana
      - ./deploy/monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./deploy/monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - cc_lite_internal
    ports:
      # CRITICAL: Use 127.0.0.1 binding for security
      - "127.0.0.1:3000:3000"
    depends_on:
      - prometheus
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        labels: "service=voice-kraliki-grafana"

  # Log Aggregation - Loki
  loki:
    image: grafana/loki:latest
    container_name: voice-kraliki-loki-prod
    restart: unless-stopped
    user: "10001:10001"  # loki user
    volumes:
      - ./deploy/monitoring/loki.yml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
      - /etc/localtime:/etc/localtime:ro
    networks:
      - cc_lite_internal
    ports:
      # CRITICAL: Use 127.0.0.1 binding for security
      - "127.0.0.1:3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        labels: "service=voice-kraliki-loki"

  # Backup Service - Automated Database & Redis Backups
  backup:
    image: postgres:15-alpine
    container_name: voice-kraliki-backup-prod
    restart: "no"  # Manual execution via cron
    user: postgres
    environment:
      PGPASSWORD_FILE: /run/secrets/cc_lite_db_password
      POSTGRES_HOST: postgres
      POSTGRES_DB: cc_light_prod
      POSTGRES_USER: cc_lite_user
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-30}
    secrets:
      - cc_lite_db_password
    volumes:
      - postgres_backups:/backups
      - ./deploy/scripts/backup.sh:/backup.sh:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - cc_lite_internal
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    entrypoint: ["/backup.sh"]
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"
        labels: "service=voice-kraliki-backup"

# ==============================================================================
# VOLUMES - Persistent Data Storage
# ==============================================================================
volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/voice-kraliki/data/postgres
  postgres_backups:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/voice-kraliki/backups/postgres
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/voice-kraliki/data/redis
  app_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/voice-kraliki/logs/app
  app_uploads:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/voice-kraliki/uploads
  nginx_cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/voice-kraliki/cache/nginx
  nginx_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/voice-kraliki/logs/nginx
  prometheus_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/voice-kraliki/data/prometheus
  grafana_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/voice-kraliki/data/grafana
  loki_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/voice-kraliki/data/loki

# ==============================================================================
# NETWORKS - Secure Container Networking
# ==============================================================================
networks:
  # Internal network - backend services only
  cc_lite_internal:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.20.0.0/16
    driver_opts:
      com.docker.network.bridge.name: voice-kraliki-internal
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "false"

  # External network - internet-facing services
  cc_lite_external:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
    driver_opts:
      com.docker.network.bridge.name: voice-kraliki-external
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"

# ==============================================================================
# YAML ANCHORS - Reusable Configuration Patterns
# ==============================================================================
x-logging-defaults: &logging-defaults
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "5"

x-security-defaults: &security-defaults
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 30s

x-resource-small: &resource-small
  limits:
    cpus: '0.5'
    memory: 512M
  reservations:
    cpus: '0.25'
    memory: 256M

x-resource-medium: &resource-medium
  limits:
    cpus: '1.0'
    memory: 1G
  reservations:
    cpus: '0.5'
    memory: 512M

x-resource-large: &resource-large
  limits:
    cpus: '2.0'
    memory: 2G
  reservations:
    cpus: '1.0'
    memory: 1G
