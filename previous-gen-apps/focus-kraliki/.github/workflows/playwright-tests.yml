name: Playwright E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  install-deps:
    name: Install dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

  focus-kraliki-tests:
    name: Focus by Kraliki E2E Tests
    runs-on: ubuntu-latest
    needs: install-deps
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Start services
        run: |
          docker-compose up -d postgres redis
          sleep 10

      - name: Run backend
        run: |
          cd backend
          pnpm dev &
          cd ..
          sleep 15

      - name: Run frontend
        run: |
          cd frontend
          pnpm dev &
          cd ..
          sleep 15

      - name: Run Playwright tests
        run: |
          npx playwright test --config=playwright.config.ts --project=${{ matrix.browser }}
        env:
          FOCUS_LITE_BASE_URL: http://localhost:5173

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-results-${{ matrix.browser }}
          path: test-results/

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-screenshots-${{ matrix.browser }}
          path: test-results/screenshots/

  business-ops-tests:
    name: Business Operations Tests
    runs-on: ubuntu-latest
    needs: install-deps
    if: github.event_name == 'push' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Start all services
        run: |
          docker-compose up -d postgres redis
          sleep 10

      - name: Run backend
        run: |
          cd backend
          pnpm dev &
          cd ..
          sleep 15

      - name: Run frontend
        run: |
          cd frontend
          pnpm dev &
          cd ..
          sleep 15

      - name: Run Business Operations tests
        run: |
          node scripts/test-runner.js business-ops
        env:
          BUSINESS_OPS_BASE_URL: http://localhost:3000
          FOCUS_LITE_BASE_URL: http://localhost:5173

      - name: Upload business ops results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: business-ops-results
          path: test-results/business-ops/

  accessibility-tests:
    name: Accessibility & Mobile Tests
    runs-on: ubuntu-latest
    needs: install-deps
    if: github.event_name == 'push' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Start services
        run: |
          docker-compose up -d postgres redis
          sleep 10

      - name: Run backend
        run: |
          cd backend
          pnpm dev &
          cd ..
          sleep 15

      - name: Run frontend
        run: |
          cd frontend
          pnpm dev &
          cd ..
          sleep 15

      - name: Run accessibility tests
        run: |
          node scripts/test-runner.js accessibility
        env:
          ACCESSIBILITY_TEST: true

      - name: Upload accessibility results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: accessibility-results
          path: test-results/

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: install-deps
    if: github.event_name == 'push' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Start services
        run: |
          docker-compose up -d postgres redis
          sleep 10

      - name: Run backend
        run: |
          cd backend
          pnpm dev &
          cd ..
          sleep 15

      - name: Run frontend
        run: |
          cd frontend
          pnpm dev &
          cd ..
          sleep 15

      - name: Run performance tests
        run: |
          node scripts/test-runner.js performance
        env:
          PERFORMANCE_TEST: true

      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: performance-results
          path: test-results/

  publish-results:
    name: Publish Test Results
    runs-on: ubuntu-latest
    needs: [focus-kraliki-tests, business-ops-tests, accessibility-tests, performance-tests]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate comprehensive report
        run: |
          node scripts/test-runner.js all
        env:
          CI: true

      - name: Upload test report
        uses: actions/upload-artifact@v3
        with:
          name: comprehensive-test-report
          path: test-results/comprehensive-test-report.json

      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = './comprehensive-test-report/comprehensive-test-report.json';

            if (fs.existsSync(path)) {
              const report = JSON.parse(fs.readFileSync(path, 'utf8'));
              const summary = report.summary;

              const comment = `
              ## ğŸ§ª Test Results Summary

              **Total Suites:** ${summary.total}
              **Passed:** âœ… ${summary.passed}
              **Failed:** âŒ ${summary.failed}
              **Skipped:** â­ï¸ ${summary.skipped}

              **Success Rate:** ${((summary.passed / summary.total) * 100).toFixed(1)}%

              ### Detailed Results
              ${Object.entries(report.suites).map(([name, suite]) =>
                `- **${name}:** ${suite.status === 'passed' ? 'âœ…' : 'âŒ'} (${suite.duration}ms)`
              ).join('\n')}

              ğŸ“Š Full report available in artifacts.
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Update test status badge
        if: github.ref == 'refs/heads/main'
        run: |
          # Here you would update a badge or deploy the test results
          echo "Test status would be updated here"