import{w as k}from"./CABBFY_M.js";import{a as u}from"./CBf0kXIe.js";import{i as l,o as c,q as d,c as w,O as g}from"./DOSPKQyx.js";const y={tasks:[],isLoading:!1,error:null,filters:{}};function L(){const{subscribe:p,set:T,update:o}=k(y);return{subscribe:p,async loadTasks(e){o(t=>({...t,isLoading:!0,error:null,filters:e||{}}));try{if(!l()){const a=(await c.getAll()).filter(i=>{if(e?.status&&i.status!==e.status||e?.type&&i.type!==e.type||e?.priority&&i.priority!==e.priority)return!1;if(e?.search){const n=e.search.toLowerCase();return i.title.toLowerCase().includes(n)||(i.description||"").toLowerCase().includes(n)}return!0});return o(i=>({...i,tasks:a,isLoading:!1})),{success:!0,tasks:a}}const s=(await u.tasks.list(e)).tasks||[];await w(g.TASKS);for(const r of s)await c.save(r);return o(r=>({...r,tasks:s,isLoading:!1})),{success:!0,tasks:s}}catch(t){const s=t.detail||"Failed to load tasks";return o(r=>({...r,isLoading:!1,error:s})),{success:!1,error:s}}},async createTask(e){try{if(!l()){const s=new Date().toISOString(),r={id:crypto.randomUUID?.()||`offline-${Date.now()}`,title:e.title||"Untitled task",description:e.description,status:e.status||"PENDING",priority:e.priority||"MEDIUM",type:e.type,due_date:e.due_date,completed_at:e.completed_at,created_at:s,updated_at:s,workspaceId:e.workspaceId,assignedUserId:e.assignedUserId};return await c.save(r),await d({type:"create",entity:"task",data:e,endpoint:"/tasks"}),o(a=>({...a,tasks:[r,...a.tasks]})),{success:!0,task:r}}const t=await u.tasks.create(e);return await c.save(t),o(s=>({...s,tasks:[t,...s.tasks]})),{success:!0,task:t}}catch(t){return{success:!1,error:t.detail||"Failed to create task"}}},async updateTask(e,t){try{if(!l()){const r=new Date().toISOString();let a=null;return o(i=>{const n=i.tasks.map(f=>f.id!==e?f:(a={...f,...t,updated_at:r},a));return{...i,tasks:n}}),a&&await c.save(a),await d({type:"update",entity:"task",data:t,endpoint:`/tasks/${e}`}),{success:!0,task:a}}const s=await u.tasks.update(e,t);return await c.save(s),o(r=>({...r,tasks:r.tasks.map(a=>a.id===e?s:a)})),{success:!0,task:s}}catch(s){return{success:!1,error:s.detail||"Failed to update task"}}},async toggleTask(e){try{if(!l()){let s=null;return o(r=>{const a=r.tasks.map(i=>{if(i.id!==e)return i;const n=i.status==="COMPLETED"?"PENDING":"COMPLETED";return s={...i,status:n,completed_at:n==="COMPLETED"?new Date().toISOString():void 0},s});return{...r,tasks:a}}),s&&await c.save(s),await d({type:"create",entity:"task",data:{},endpoint:`/tasks/${e}/toggle`}),{success:!0,task:s}}const t=await u.tasks.toggle(e);return await c.save(t),o(s=>({...s,tasks:s.tasks.map(r=>r.id===e?t:r)})),{success:!0,task:t}}catch(t){return{success:!1,error:t.detail||"Failed to toggle task"}}},async deleteTask(e){try{return l()?(await u.tasks.delete(e),o(t=>({...t,tasks:t.tasks.filter(s=>s.id!==e)})),{success:!0}):(await c.delete(e),await d({type:"delete",entity:"task",data:{},endpoint:`/tasks/${e}`}),o(t=>({...t,tasks:t.tasks.filter(s=>s.id!==e)})),{success:!0})}catch(t){return{success:!1,error:t.detail||"Failed to delete task"}}},async searchTasks(e){o(t=>({...t,isLoading:!0}));try{if(!l()){const r=await c.getAll(),a=e.toLowerCase(),i=r.filter(n=>n.title.toLowerCase().includes(a)||(n.description||"").toLowerCase().includes(a));return o(n=>({...n,tasks:i,isLoading:!1,filters:{...n.filters,search:e}})),{success:!0,tasks:i}}const s=(await u.tasks.search(e)).tasks||[];return o(r=>({...r,tasks:s,isLoading:!1,filters:{...r.filters,search:e}})),{success:!0,tasks:s}}catch(t){const s=t.detail||"Search failed";return o(r=>({...r,isLoading:!1,error:s})),{success:!1,error:s}}},clearError(){o(e=>({...e,error:null}))},clearFilters(){o(e=>({...e,filters:{}}))}}}const h=L();export{h as t};
