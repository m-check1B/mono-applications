import{d as Ce,f,a as p,s as A,c as ne,e as Me}from"../chunks/C3NdowuV.js";import{o as Ke,a as Pe}from"../chunks/BEA_S9YB.js";import{z as ve,A as ze,p as Ne,b as Y,e as Ae,a as Ie,o as Ee,h as r,E as $e,g as W,$ as Re,c as n,r as o,s as m,t as I,i as ie}from"../chunks/BIIBwolN.js";import{e as ce,i as de}from"../chunks/C5feot9S.js";import{i as O}from"../chunks/BMZK_lNp.js";import{h as De}from"../chunks/DCFnHnzv.js";import{s as je,r as We}from"../chunks/kJGk4-vF.js";import{s as ee}from"../chunks/3ECVvnw7.js";import{b as Je}from"../chunks/V2_FqNi0.js";import{s as Le,a as te}from"../chunks/BfLFXwF2.js";import{p as Ve}from"../chunks/COXvSIfD.js";import{v as le,b as Ye,d as Be}from"../chunks/BXAMcmxS.js";const se={status:"idle",mode:"voice",transcript:[],currentMessage:"",isRecording:!1,isProcessing:!1,error:null,wsConnection:null,conversationId:null,reachMode:!1,reachSessionId:null,startedAt:null,magicToken:null};function Ze(){const{subscribe:C,set:re,update:a}=ze(se),g=t=>{if(t.startsWith("ws://")||t.startsWith("wss://"))return t;if(t.startsWith("http://")||t.startsWith("https://")){const s=t.startsWith("https://")?"wss":"ws";return t.replace(/^https?:\/\//,`${s}://`)}return`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}${t}`};return{subscribe:C,connect:async t=>{a(e=>({...e,status:"connecting",magicToken:t}));try{const e=await le.start(t,se.mode),s=e.reach===!0,b=g(e.websocket_url),y=new WebSocket(b);y.onopen=()=>{a(u=>({...u,status:"active",wsConnection:y,reachMode:s,conversationId:e.conversation_id,reachSessionId:e.reach_session_id||null,startedAt:Date.now()}))},y.onmessage=u=>{const v=JSON.parse(u.data);if(v.type==="error"){a(c=>{var M;return{...c,status:"error",error:v.message||v.error||((M=v.data)==null?void 0:M.error)||"Connection error"}});return}!s&&v.type==="ai_message"&&a(c=>({...c,transcript:[...c.transcript,{role:"ai",content:v.content,timestamp:new Date().toISOString()}],isProcessing:!1})),s&&v.type==="text.output"&&a(c=>{var M;return{...c,transcript:[...c.transcript,{role:"ai",content:((M=v.data)==null?void 0:M.text)||"",timestamp:new Date().toISOString()}],isProcessing:!1}}),!s&&v.type==="completed"&&a(c=>({...c,status:"completed"})),!s&&v.type==="mode_changed"&&a(c=>({...c,mode:v.mode}))},y.onerror=()=>{a(u=>({...u,status:"error",error:"Connection error"}))},y.onclose=()=>{a(u=>({...u,wsConnection:null}))},a(u=>({...u,wsConnection:y}))}catch(e){a(s=>({...s,status:"error",error:(e==null?void 0:e.message)||"Failed to start voice session"}))}},sendMessage:(t,e="text")=>{a(s=>{var b;return((b=s.wsConnection)==null?void 0:b.readyState)===WebSocket.OPEN?(s.wsConnection.send(JSON.stringify({type:e,content:t})),{...s,transcript:[...s.transcript,{role:"user",content:t,timestamp:new Date().toISOString()}],currentMessage:"",isProcessing:!0}):s})},endConversation:async()=>{let t;if(a(e=>{var s;return t=e,((s=e.wsConnection)==null?void 0:s.readyState)===WebSocket.OPEN&&(e.reachMode||e.wsConnection.send(JSON.stringify({type:"end"})),e.wsConnection.close()),e}),t&&t.reachMode&&t.magicToken){const e=t.startedAt?Math.max(0,Math.floor((Date.now()-t.startedAt)/1e3)):void 0;try{await le.complete(t.magicToken,t.transcript,e)}catch{}}a(e=>({...e,status:"completed"}))},switchToText:(t="user_requested")=>{a(e=>{var s;return!e.reachMode&&((s=e.wsConnection)==null?void 0:s.readyState)===WebSocket.OPEN&&e.wsConnection.send(JSON.stringify({type:"fallback",reason:t})),{...e,mode:"text"}})},setRecording:t=>{a(e=>({...e,isRecording:t}))},setCurrentMessage:t=>{a(e=>({...e,currentMessage:t}))},setConsent:()=>{a(t=>({...t,status:"consent"}))},reset:()=>{a(t=>{var e;return(e=t.wsConnection)==null||e.close(),se})}}}const T=Ze();ve(T,C=>C.status==="active");const qe=ve(T,C=>C.transcript);var Fe=f('<div class="brutal-card max-w-lg w-full p-8 text-center relative z-20"><div class="text-system-red text-4xl mb-4 font-display">!</div> <h1 class="text-xl mb-4 font-display">CHYBA</h1> <p class="text-muted-foreground font-mono"> </p></div>'),He=f('<div class="p-3 border-2 border-foreground bg-card brutal-shadow-sm text-sm"><div class="flex items-center gap-2 mb-1"><span> </span></div> <span class="font-mono"> </span></div>'),Ge=f('<div class="mt-8 pt-6 border-t-2 border-foreground"><h3 class="text-sm font-bold mb-4 uppercase font-display">Co děláme s vaší zpětnou vazbou</h3> <div class="space-y-3"></div></div>'),Ue=f('<div class="brutal-card max-w-lg w-full p-8 relative z-20"><div class="text-center mb-6"><div class="text-terminal-green text-3xl mb-2 font-display">///</div> <h1 class="text-2xl font-display">SPEAK BY KRALIKI</h1></div> <p class="mb-6 text-center font-mono">Ahoj! Toto je tvůj měsíční prostor pro zpětnou vazbu.</p> <div class="border-2 border-terminal-green p-4 mb-6 bg-void brutal-shadow-sm"><div class="flex items-center gap-2 mb-2 font-mono text-sm"><span class="text-terminal-green">[OK]</span> <span>Rozhovor je 100% ANONYMNÍ</span></div> <div class="flex items-center gap-2 mb-2 font-mono text-sm"><span class="text-terminal-green">[OK]</span> <span>Tvůj nadřízený NEUVIDÍ co jsi řekl/a</span></div> <div class="flex items-center gap-2 mb-2 font-mono text-sm"><span class="text-terminal-green">[OK]</span> <span>Vedení vidí pouze agregované trendy</span></div> <div class="flex items-center gap-2 mb-2 font-mono text-sm"><span class="text-terminal-green">[OK]</span> <span>Po rozhovoru si můžeš přečíst a upravit přepis</span></div> <div class="flex items-center gap-2 font-mono text-sm"><span class="text-terminal-green">[OK]</span> <span>Můžeš kdykoliv požádat o smazání svých dat</span></div></div> <p class="text-sm text-muted-foreground mb-6 text-center font-mono">Rozhovor trvá cca 5 minut.</p> <button class="brutal-btn brutal-btn-primary w-full mb-4">ROZUMÍM, POJĎME NA TO</button> <div class="text-center"><button type="button" class="text-sm text-muted-foreground hover:text-foreground bg-transparent border-none cursor-pointer font-mono uppercase">Nechci odpovídat: Přeskočit tento měsíc</button></div> <!></div>'),Xe=f('<div class="brutal-card max-w-lg w-full p-8 text-center relative z-20"><div class="text-terminal-green text-4xl mb-4 font-display">OK</div> <h1 class="text-xl mb-4 font-display">DĚKUJEME!</h1> <p class="text-muted-foreground mb-6 font-mono">Tvoje zpětná vazba byla zaznamenána. Vážíme si tvého času.</p> <a class="brutal-btn">ZOBRAZIT PŘEPIS</a></div>'),Qe=f('<div class="voice-ring"></div>'),et=f('<button class="brutal-btn text-[10px] py-1 px-2">PŘEJÍT NA TEXT</button>'),tt=f('<div><div class="text-[10px] text-muted-foreground mb-1 font-mono uppercase tracking-tighter"> </div> <div> </div></div>'),st=f('<div class="mb-4"><div class="text-[10px] text-muted-foreground mb-1 font-mono uppercase">SPEAK BY KRALIKI</div> <div class="inline-block p-3 bg-card border-2 border-foreground font-mono text-sm italic"><span class="animate-pulse">Přemýšlím...</span></div></div>'),rt=f('<div class="flex gap-2"><input type="text" placeholder="Napiš svou odpověď..." class="brutal-input flex-1 text-sm"/> <button class="brutal-btn brutal-btn-primary">ODESLAT</button></div>'),ot=f('<div class="text-center text-sm text-muted-foreground font-mono border-2 border-dashed border-foreground/30 py-6"><p class="animate-pulse">MLUV DO MIKROFONU...</p> <p class="text-[10px] mt-2 opacity-50 uppercase">Nebo přepni na textový režim výše</p></div>'),at=f('<div class="brutal-card max-w-2xl w-full p-6 relative z-20"><div class="flex items-center justify-between mb-6"><div class="flex items-center gap-3"><div class="relative"><div class="voice-indicator"></div> <!></div> <span class="text-xs text-muted-foreground font-mono uppercase tracking-widest"> </span></div> <div class="flex gap-2"><!> <button class="brutal-btn brutal-btn-danger text-[10px] py-1 px-2">UKONČIT</button></div></div> <div class="h-[400px] overflow-y-auto mb-6 p-4 bg-void border-2 border-foreground brutal-shadow-sm"><!> <!></div> <!></div>'),nt=f('<div class="min-h-screen flex items-center justify-center p-4 bg-void relative overflow-hidden"><!></div>');function _t(C,re){Ne(re,!0);const a=()=>te(Ve,"$page",e),g=()=>te(T,"$voiceStore",e),t=()=>te(qe,"$conversationTranscript",e),[e,s]=Le(),b=$e(()=>a().params.token);let y=Y(!1),u=Y(Ae([])),v=Y(null),c=Y("");Ke(async()=>{if(r(b))try{W(u,await Ye.public(r(b)),!0)}catch{}}),Pe(()=>{T.reset()});async function M(){if(r(b))try{await Be.consent(r(b)),W(y,!0),T.connect(r(b))}catch{W(v,"Neplatny nebo vyprsely odkaz")}}function oe(){r(c).trim()&&(T.sendMessage(r(c).trim()),W(c,""))}function pe(d){d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),oe())}function me(){T.switchToText("user_requested")}function ue(){T.endConversation()}function fe(d){return{new:"Novy",heard:"Slysime vas",in_progress:"Resime",resolved:"Vyreseno"}[d]||d}function be(d){return{new:"text-cyan-data",heard:"text-terminal-green",in_progress:"text-yellow-400",resolved:"text-gray-500"}[d]||""}var B=nt();De("weknjb",d=>{Ee(()=>{Re.title="Speak by Kraliki - Check-in"})});var xe=n(B);{var ge=d=>{var w=Fe(),J=m(n(w),4),Z=n(J,!0);o(J),o(w),I(()=>A(Z,r(v))),p(d,w)},_e=d=>{var w=ne(),J=ie(w);{var Z=K=>{var P=Ue(),L=m(n(P),8);L.__click=M;var q=m(L,4);{var F=_=>{var x=Ge(),S=m(n(x),2);ce(S,21,()=>r(u).slice(0,3),de,(E,k)=>{var $=He(),R=n($),z=n(R),H=n(z);o(z),o(R);var D=m(R,2),V=n(D,!0);o(D),o($),I((G,U)=>{ee(z,1,`${G??""} font-bold font-mono`),A(H,`[${U??""}]`),A(V,r(k).public_message||r(k).topic)},[()=>be(r(k).status),()=>fe(r(k).status)]),p(E,$)}),o(S),o(x),p(_,x)};O(q,_=>{r(u).length>0&&_(F)})}o(P),p(K,P)},he=K=>{var P=ne(),L=ie(P);{var q=_=>{var x=Xe(),S=m(n(x),6);o(x),I(()=>je(S,"href",`/v/${r(b)}/transcript`)),p(_,x)},F=_=>{var x=at(),S=n(x),E=n(S),k=n(E),$=m(n(k),2);{var R=i=>{var l=Qe();p(i,l)};O($,i=>{g().isRecording&&i(R)})}o(k);var z=m(k,2),H=n(z,!0);o(z),o(E);var D=m(E,2),V=n(D);{var G=i=>{var l=et();l.__click=me,p(i,l)};O(V,i=>{g().mode==="voice"&&i(G)})}var U=m(V,2);U.__click=ue,o(D),o(S);var X=m(S,2),ae=n(X);ce(ae,1,t,de,(i,l)=>{var h=tt(),N=n(h),j=n(N,!0);o(N);var Q=m(N,2),Te=n(Q,!0);o(Q),o(h),I(()=>{ee(h,1,`mb-6 ${r(l).role==="ai"?"":"text-right"}`),A(j,r(l).role==="ai"?"SPEAK BY KRALIKI":"TY"),ee(Q,1,`inline-block max-w-[85%] p-3 font-mono text-sm ${r(l).role==="ai"?"bg-card border-2 border-foreground brutal-shadow-sm":"bg-terminal-green text-black border-2 border-black"}`),A(Te,r(l).content)}),p(i,h)});var ye=m(ae,2);{var we=i=>{var l=st();p(i,l)};O(ye,i=>{g().isProcessing&&i(we)})}o(X);var Se=m(X,2);{var ke=i=>{var l=rt(),h=n(l);We(h);var N=m(h,2);N.__click=oe,o(l),I(j=>{h.disabled=g().isProcessing,N.disabled=j},[()=>g().isProcessing||!r(c).trim()]),Me("keypress",h,pe),Je(h,()=>r(c),j=>W(c,j)),p(i,l)},Oe=i=>{var l=ot();p(i,l)};O(Se,i=>{g().mode==="text"?i(ke):i(Oe,!1)})}o(x),I(()=>A(H,g().mode==="voice"?"Hlasový režim":"Textový režim")),p(_,x)};O(L,_=>{g().status==="completed"?_(q):_(F,!1)},!0)}p(K,P)};O(J,K=>{r(y)?K(he,!1):K(Z)},!0)}p(d,w)};O(xe,d=>{r(v)?d(ge):d(_e,!1)})}o(B),p(C,B),Ie(),s()}Ce(["click"]);export{_t as component};
