# Speak by Kraliki - Docker Compose
# Production deployment with Traefik integration
#
# Usage: docker compose up -d

networks:
  websites_default:
    external: true
  speak-internal:
    driver: bridge

volumes:
  vop_postgres_data:

services:
  # PostgreSQL Database
  db:
    image: postgres:17-alpine
    container_name: speak-kraliki-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - vop_postgres_data:/var/lib/postgresql/data
    networks:
      - speak-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      timeout: 5s
      retries: 5
    ports:
      - "127.0.0.1:5435:5432"  # SECURITY: Bind to localhost only, not 0.0.0.0
    restart: unless-stopped

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: speak-kraliki-backend
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - DEBUG=false
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_MODEL=${GEMINI_MODEL:-models/gemini-2.5-flash-native-audio-preview-12-2025}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - websites_default
      - speak-internal
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=websites_default"
      # API routes
      - "traefik.http.routers.speak-api.rule=Host(`speak.kraliki.com`) && PathPrefix(`/api`)"
      - "traefik.http.routers.speak-api.entrypoints=websecure"
      - "traefik.http.routers.speak-api.tls=true"
      - "traefik.http.routers.speak-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.speak-api.priority=100"
      # Docs route
      - "traefik.http.routers.speak-docs.rule=Host(`speak.kraliki.com`) && PathPrefix(`/docs`)"
      - "traefik.http.routers.speak-docs.entrypoints=websecure"
      - "traefik.http.routers.speak-docs.tls=true"
      - "traefik.http.routers.speak-docs.tls.certresolver=letsencrypt"
      - "traefik.http.routers.speak-docs.priority=100"
      # OpenAPI spec route
      - "traefik.http.routers.speak-openapi.rule=Host(`speak.kraliki.com`) && PathPrefix(`/openapi.json`)"
      - "traefik.http.routers.speak-openapi.entrypoints=websecure"
      - "traefik.http.routers.speak-openapi.tls=true"
      - "traefik.http.routers.speak-openapi.tls.certresolver=letsencrypt"
      - "traefik.http.routers.speak-openapi.priority=100"
      # Production Health route
      - "traefik.http.routers.speak-health.rule=Host(`speak.kraliki.com`) && PathPrefix(`/health`)"
      - "traefik.http.routers.speak-health.entrypoints=websecure"
      - "traefik.http.routers.speak-health.tls=true"
      - "traefik.http.routers.speak-health.tls.certresolver=letsencrypt"
      - "traefik.http.routers.speak-health.priority=100"
      # Beta routes (verduona.dev - public testing)
      - "traefik.http.routers.speak-api-beta.rule=Host(`speak.verduona.dev`) && PathPrefix(`/api`)"
      - "traefik.http.routers.speak-api-beta.entrypoints=websecure"
      - "traefik.http.routers.speak-api-beta.tls=true"
      - "traefik.http.routers.speak-api-beta.tls.certresolver=letsencrypt"
      - "traefik.http.routers.speak-api-beta.priority=100"
      - "traefik.http.routers.speak-docs-beta.rule=Host(`speak.verduona.dev`) && PathPrefix(`/docs`)"
      - "traefik.http.routers.speak-docs-beta.entrypoints=websecure"
      - "traefik.http.routers.speak-docs-beta.tls=true"
      - "traefik.http.routers.speak-docs-beta.tls.certresolver=letsencrypt"
      - "traefik.http.routers.speak-docs-beta.priority=100"
      # Beta Health route
      - "traefik.http.routers.speak-health-beta.rule=Host(`speak.verduona.dev`) && PathPrefix(`/health`)"
      - "traefik.http.routers.speak-health-beta.entrypoints=websecure"
      - "traefik.http.routers.speak-health-beta.tls=true"
      - "traefik.http.routers.speak-health-beta.tls.certresolver=letsencrypt"
      - "traefik.http.routers.speak-health-beta.priority=100"
      # Dev routes (localhost)
      - "traefik.http.routers.speak-api-dev.rule=Host(`speak.verduona.localhost`) && PathPrefix(`/api`)"
      - "traefik.http.routers.speak-api-dev.entrypoints=web"
      - "traefik.http.routers.speak-api-dev.priority=100"
      - "traefik.http.routers.speak-docs-dev.rule=Host(`speak.verduona.localhost`) && PathPrefix(`/docs`)"
      - "traefik.http.routers.speak-docs-dev.entrypoints=web"
      - "traefik.http.routers.speak-docs-dev.priority=100"
      - "traefik.http.services.speak-backend.loadbalancer.server.port=8000"
    restart: unless-stopped

  # Frontend (SvelteKit dev server - for now)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: speak-kraliki-frontend
    environment:
      - NODE_ENV=development
      - PUBLIC_API_URL=/api
    networks:
      - websites_default
    labels:
      - "traefik.enable=true"
      # Production
      - "traefik.http.routers.speak-frontend.rule=Host(`speak.kraliki.com`)"
      - "traefik.http.routers.speak-frontend.entrypoints=websecure"
      - "traefik.http.routers.speak-frontend.tls=true"
      - "traefik.http.routers.speak-frontend.tls.certresolver=letsencrypt"
      # HTTP redirect
      - "traefik.http.routers.speak-frontend-http.rule=Host(`speak.kraliki.com`)"
      - "traefik.http.routers.speak-frontend-http.entrypoints=web"
      - "traefik.http.routers.speak-frontend-http.middlewares=redirect-to-https@docker"
      # Beta (verduona.dev - public testing)
      - "traefik.http.routers.speak-frontend-beta.rule=Host(`speak.verduona.dev`)"
      - "traefik.http.routers.speak-frontend-beta.entrypoints=websecure"
      - "traefik.http.routers.speak-frontend-beta.tls=true"
      - "traefik.http.routers.speak-frontend-beta.tls.certresolver=letsencrypt"
      - "traefik.http.routers.speak-frontend-beta-http.rule=Host(`speak.verduona.dev`)"
      - "traefik.http.routers.speak-frontend-beta-http.entrypoints=web"
      - "traefik.http.routers.speak-frontend-beta-http.middlewares=redirect-to-https@docker"
      # Dev (localhost)
      - "traefik.http.routers.speak-frontend-dev.rule=Host(`speak.verduona.localhost`)"
      - "traefik.http.routers.speak-frontend-dev.entrypoints=web"
      - "traefik.http.services.speak-frontend.loadbalancer.server.port=5173"
    restart: unless-stopped
